<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>LDD3 学习笔记 | R0gerThat</title><meta name="author" content="RT"><meta name="copyright" content="RT"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="LDD3 代码补充">
<meta property="og:type" content="article">
<meta property="og:title" content="LDD3 学习笔记">
<meta property="og:url" content="https://wr-web.github.io/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/index.html">
<meta property="og:site_name" content="R0gerThat">
<meta property="og:description" content="LDD3 代码补充">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg">
<meta property="article:published_time" content="2024-05-07T04:00:00.000Z">
<meta property="article:modified_time" content="2024-06-24T04:54:18.102Z">
<meta property="article:author" content="RT">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wr-web/picture/archive02.jpg"><link rel="canonical" href="https://wr-web.github.io/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LDD3 学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-24 12:54:18'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="R0gerThat" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="R0gerThat"><span class="site-name">R0gerThat</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">LDD3 学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-07T04:00:00.000Z" title="发表于 2024-05-07 12:00:00">2024-05-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-24T04:54:18.102Z" title="更新于 2024-06-24 12:54:18">2024-06-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="LDD3 学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="LDD3-WEEK4"><a href="#LDD3-WEEK4" class="headerlink" title="LDD3 WEEK4"></a>LDD3 WEEK4</h1><h1 id="代码补充"><a href="#代码补充" class="headerlink" title="代码补充"></a>代码补充</h1><p>环境</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">Linux rogerthat 5.19.0-46-generic #47-Ubuntu SMP PREEMPT_DYNAMIC Fri Jun 16 13:30:11 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="第五章"><a href="#第五章" class="headerlink" title="第五章"></a>第五章</h2><h3 id="complete"><a href="#complete" class="headerlink" title="complete"></a>complete</h3><p>轻量级的一种同步机制</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h></span>  <span class="token comment">/* current and everything */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span> <span class="token comment">/* printk() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>     <span class="token comment">/* everything... */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span>  <span class="token comment">/* size_t */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/completion.h></span></span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> complete_major <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">DECLARE_COMPLETION</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ssize_t</span> <span class="token function">complete_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_DEBUG <span class="token string">"process %i (%s) going to sleep\n"</span><span class="token punctuation">,</span>
			current<span class="token operator">-></span>pid<span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">wait_for_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>comp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_DEBUG <span class="token string">"awoken %i (%s)\n"</span><span class="token punctuation">,</span> current<span class="token operator">-></span>pid<span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* EOF */</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">ssize_t</span> <span class="token function">complete_write</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
		<span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_DEBUG <span class="token string">"process %i (%s) awakening the readers...\n"</span><span class="token punctuation">,</span>
			current<span class="token operator">-></span>pid<span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">complete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>comp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span> <span class="token comment">/* succeed, to avoid retrial */</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> complete_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span>  complete_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span> complete_write<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">complete_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Register your major, and accept a dynamic number
	 */</span>
	result <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>complete_major<span class="token punctuation">,</span> <span class="token string">"complete"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>complete_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>complete_major <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		complete_major <span class="token operator">=</span> result<span class="token punctuation">;</span> <span class="token comment">/* dynamic */</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">complete_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>complete_major<span class="token punctuation">,</span> <span class="token string">"complete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>complete_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>complete_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240516141337151.png" alt="image-20240516141337151"></p>
<h2 id="第六章"><a href="#第六章" class="headerlink" title="第六章"></a>第六章</h2><h3 id="异步通知"><a href="#异步通知" class="headerlink" title="异步通知"></a>异步通知</h3><p>通过 SIGIO 完成，需要使能</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">int</span> gotdata<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sighandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>signo<span class="token operator">==</span>SIGIO<span class="token punctuation">)</span>
        gotdata<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> action<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>action<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    action<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sighandler<span class="token punctuation">;</span>
    action<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGIO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>action<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fcntl</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> F_SETOWN<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span> <span class="token operator">|</span> FASYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* this only returns if a signal arrives */</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* one day */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gotdata<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        count<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* buggy: if avail data is more than 4kbytes... */</span>
        count<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gotdata<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240516144923597.png" alt="image-20240516144923597"></p>
<h3 id="llseek"><a href="#llseek" class="headerlink" title="llseek"></a>llseek</h3><p>scull 代码，实现了 llseek，对于一些提供数据流的设备，不应支持 llseek</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">loff_t</span> <span class="token function">scull_llseek</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token class-name">loff_t</span> newpos<span class="token punctuation">;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>whence<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	  <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">/* SEEK_SET */</span>
	  	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"SEEK_SET\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newpos <span class="token operator">=</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	  <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">/* SEEK_CUR */</span>
	  	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"SEEK_CUR\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newpos <span class="token operator">=</span> filp<span class="token operator">-></span>f_pos <span class="token operator">+</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	  <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token comment">/* SEEK_END */</span>
	  	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"SEEK_END\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newpos <span class="token operator">=</span> dev<span class="token operator">-></span>size <span class="token operator">+</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">/* can't happen */</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>newpos <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	filp<span class="token operator">-></span>f_pos <span class="token operator">=</span> newpos<span class="token punctuation">;</span>
	<span class="token keyword">return</span> newpos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进行一个简单的测试</p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240516152231158.png" alt="image-20240516152231158"></p>
<h3 id="文件访问控制"><a href="#文件访问控制" class="headerlink" title="文件访问控制"></a>文件访问控制</h3><p>简单的写一个 open &lt;device&gt;</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span> </span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: %s &lt;device>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="scullsingle"><a href="#scullsingle" class="headerlink" title="scullsingle"></a>scullsingle</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> scull_s_device<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">atomic_t</span> scull_s_available <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_s_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_s_device<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">atomic_dec_and_test</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_s_available<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_s_available<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span> <span class="token comment">/* already open */</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/* then, everything else is copied from the bare scull device */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span>
		<span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_s_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_s_available<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* release the device */</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240516163211343.png" alt="image-20240516163211343"></p>
<p>可以看出不同第二个打开失败了。</p>
<h4 id="sculluid"><a href="#sculluid" class="headerlink" title="sculluid"></a>sculluid</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> scull_u_device<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> scull_u_count<span class="token punctuation">;</span>	<span class="token comment">/* initialized to 0 by default */</span>
<span class="token keyword">static</span> <span class="token class-name">uid_t</span> scull_u_owner<span class="token punctuation">;</span>	<span class="token comment">/* initialized to 0 by default */</span>
<span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_u_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_u_device<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scull_u_count <span class="token operator">&amp;&amp;</span> 
	                <span class="token punctuation">(</span>scull_u_owner <span class="token operator">!=</span> <span class="token function">current_uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  <span class="token comment">/* allow user */</span>
	                <span class="token punctuation">(</span>scull_u_owner <span class="token operator">!=</span> <span class="token function">current_euid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">/* allow whoever did su */</span>
			<span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_DAC_OVERRIDE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* still allow root */</span>
		<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>   <span class="token comment">/* -EPERM would confuse the user */</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>scull_u_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		scull_u_owner <span class="token operator">=</span> <span class="token function">current_uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val<span class="token punctuation">;</span> <span class="token comment">/* grab it */</span>

	scull_u_count<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* then, everything else is copied from the bare scull device */</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span>
		<span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>比较清晰</p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240516163901501.png" alt="image-20240516163901501"></p>
<h4 id="scullpriv"><a href="#scullpriv" class="headerlink" title="scullpriv"></a>scullpriv</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/************************************************************************
 *
 * Finally the `cloned' private device. This is trickier because it
 * involves list management, and dynamic allocation.
 */</span>

<span class="token comment">/* The clone-specific data structure includes a key field */</span>

<span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> device<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> key<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
    
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/* The list of devices, and a lock to protect it */</span>
<span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>scull_c_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>scull_c_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* A placeholder scull_dev which really just holds the cdev stuff. */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> scull_c_device<span class="token punctuation">;</span>   

<span class="token comment">/* Look for a device or create one if missing */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span><span class="token function">scull_c_lookfor_device</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> key<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span> <span class="token operator">*</span>lptr<span class="token punctuation">;</span>

	<span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>lptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_c_list<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>lptr<span class="token operator">-></span>key <span class="token operator">==</span> key<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/* not found */</span>
	lptr <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lptr<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">/* initialize the device */</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>lptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	lptr<span class="token operator">-></span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
	<span class="token function">scull_trim</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* initialize it */</span>
	<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lptr<span class="token operator">-></span>device<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* place it in the list */</span>
	<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lptr<span class="token operator">-></span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_c_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_c_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> key<span class="token punctuation">;</span>
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-></span>signal<span class="token operator">-></span>tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
		<span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"Process \"%s\" has no ctl tty\n"</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	key <span class="token operator">=</span> <span class="token function">tty_devnum</span><span class="token punctuation">(</span>current<span class="token operator">-></span>signal<span class="token operator">-></span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* look for a scullc device in the list */</span>
	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_c_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dev <span class="token operator">=</span> <span class="token function">scull_c_lookfor_device</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_c_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

	<span class="token comment">/* then, everything else is copied from the bare scull device */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span>
		<span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_c_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">/*
	 * Nothing to do, because the device is persistent.
	 * A `real' cloned device should be freed on last close
	 */</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>把不同的 tty 设备当作 key。实际使用中，区分了 pts</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">rt@rogerthat ~/k/l/scull (master)> sudo dmesg
[12841.367120] tty key: major: 136, minor: 10
[12842.179333] tty key: major: 136, minor: 11<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="第七章"><a href="#第七章" class="headerlink" title="第七章"></a>第七章</h2><h3 id="时间API"><a href="#时间API" class="headerlink" title="时间API"></a>时间API</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/moduleparam.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span>	<span class="token comment">/* printk() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span>		<span class="token comment">/* kmalloc() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>		<span class="token comment">/* everything... */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span>	<span class="token comment">/* error codes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span>	<span class="token comment">/* size_t */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span>	<span class="token comment">/* O_ACCMODE */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span>	<span class="token comment">/* copy_*_user */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/time.h></span></span>


<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"RT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">unsigned</span> <span class="token keyword">long</span> t0<span class="token punctuation">,</span>t1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>t0<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">do_time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">timer_init_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    t0 <span class="token operator">=</span> jiffies<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"jiffies t0: %lu\n"</span><span class="token punctuation">,</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Timer module loaded\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">do_time_api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">timer_cleanup_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    t1 <span class="token operator">=</span> jiffies<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"jiffies t1: %lu\n"</span><span class="token punctuation">,</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"diff msec: %lu\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>t1<span class="token operator">-</span>t0<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">/</span>HZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">time_after</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"t1 after t0\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Timer module unloaded\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">do_time_api</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec64</span> tv1<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">timespec64</span> tv2<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> j1<span class="token punctuation">;</span>
	u64 j2<span class="token punctuation">;</span>

	<span class="token comment">/* get them four */</span>
	j1 <span class="token operator">=</span> jiffies<span class="token punctuation">;</span>
	j2 <span class="token operator">=</span> <span class="token function">get_jiffies_64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ktime_get_real_ts64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ktime_get_coarse_real_ts64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"0x%08lx 0x%016Lx\n"</span>
            <span class="token string">"%10i.%09i\n"</span>
	        <span class="token string">"%40i.%09i\n"</span><span class="token punctuation">,</span>
	       j1<span class="token punctuation">,</span> j2<span class="token punctuation">,</span>
	       <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> tv1<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> tv1<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">,</span>
	       <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> tv2<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> tv2<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>timer_init_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>timer_cleanup_module<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token number">27344.420102</span><span class="token punctuation">]</span> jiffies t0<span class="token operator">:</span> <span class="token number">4301728356</span>
<span class="token punctuation">[</span><span class="token number">27344.420105</span><span class="token punctuation">]</span> Timer module loaded
<span class="token punctuation">[</span><span class="token number">27344.420114</span><span class="token punctuation">]</span> <span class="token number">0x100672a64</span> <span class="token number">0x0000000100672a64</span>
               <span class="token number">1715866818.547302295</span>
                                             <span class="token number">1715866818.545032262</span>
<span class="token punctuation">[</span><span class="token number">27347.184635</span><span class="token punctuation">]</span> jiffies t1<span class="token operator">:</span> <span class="token number">4301729047</span>
<span class="token punctuation">[</span><span class="token number">27347.184644</span><span class="token punctuation">]</span> diff msec<span class="token operator">:</span> <span class="token number">2764</span>
<span class="token punctuation">[</span><span class="token number">27347.184645</span><span class="token punctuation">]</span> t1 after t0
<span class="token punctuation">[</span><span class="token number">27347.184645</span><span class="token punctuation">]</span> Timer module unloaded<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="timer"><a href="#timer" class="headerlink" title="timer"></a>timer</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">jit_timer_fn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">timer_list</span> <span class="token operator">*</span>t<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">jit_data</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">from_timer</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> t<span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> j <span class="token operator">=</span> jiffies<span class="token punctuation">;</span>
	<span class="token function">seq_printf</span><span class="token punctuation">(</span>data<span class="token operator">-></span>m<span class="token punctuation">,</span> <span class="token string">"%9li  %3li     %i    %6i   %i   %s\n"</span><span class="token punctuation">,</span>
			     j<span class="token punctuation">,</span> j <span class="token operator">-</span> data<span class="token operator">-></span>prevjiffies<span class="token punctuation">,</span> <span class="token function">in_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			     current<span class="token operator">-></span>pid<span class="token punctuation">,</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>data<span class="token operator">-></span>loops<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		data<span class="token operator">-></span>timer<span class="token punctuation">.</span>expires <span class="token operator">+=</span> tdelay<span class="token punctuation">;</span>
		data<span class="token operator">-></span>prevjiffies <span class="token operator">=</span> j<span class="token punctuation">;</span>
		<span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* the /proc function: allocate everything to allow concurrency */</span>
<span class="token keyword">int</span> <span class="token function">jit_timer_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">jit_data</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> j <span class="token operator">=</span> jiffies<span class="token punctuation">;</span>

	data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* write the first lines in the buffer */</span>
	<span class="token function">seq_puts</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"   time   delta  inirq    pid   cpu command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">seq_printf</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"%9li  %3li     %i    %6i   %i   %s\n"</span><span class="token punctuation">,</span>
			j<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token function">in_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			current<span class="token operator">-></span>pid<span class="token punctuation">,</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* fill the data for our timer function */</span>
	data<span class="token operator">-></span>prevjiffies <span class="token operator">=</span> j<span class="token punctuation">;</span>
	data<span class="token operator">-></span>m <span class="token operator">=</span> m<span class="token punctuation">;</span>
	data<span class="token operator">-></span>loops <span class="token operator">=</span> JIT_ASYNC_LOOPS<span class="token punctuation">;</span>

	<span class="token comment">/* register the timer */</span>
	<span class="token function">timer_setup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>timer<span class="token punctuation">,</span> jit_timer_fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	data<span class="token operator">-></span>timer<span class="token punctuation">.</span>expires <span class="token operator">=</span> j <span class="token operator">+</span> tdelay<span class="token punctuation">;</span> <span class="token comment">/* parameter */</span>
	<span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* wait for the buffer to fill */</span>
	<span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>data<span class="token operator">-></span>wait<span class="token punctuation">,</span> <span class="token operator">!</span>data<span class="token operator">-></span>loops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>result</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rt@rogerthat <span class="token operator">~</span><span class="token operator">/</span>k<span class="token operator">/</span>l<span class="token operator">/</span>misc<span class="token operator">-</span><span class="token function">modules</span> <span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token operator">></span> cat <span class="token operator">/</span>proc<span class="token operator">/</span>jitimer
   time   delta  inirq    pid   cpu command
<span class="token number">4302300677</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">47728</span>   <span class="token number">7</span>   cat
<span class="token number">4302300689</span>   <span class="token number">12</span>     <span class="token number">1</span>         <span class="token number">0</span>   <span class="token number">7</span>   swapper<span class="token operator">/</span><span class="token number">7</span>
<span class="token number">4302300698</span>    <span class="token number">9</span>     <span class="token number">1</span>         <span class="token number">0</span>   <span class="token number">7</span>   swapper<span class="token operator">/</span><span class="token number">7</span>
<span class="token number">4302300708</span>   <span class="token number">10</span>     <span class="token number">1</span>         <span class="token number">0</span>   <span class="token number">7</span>   swapper<span class="token operator">/</span><span class="token number">7</span>
<span class="token number">4302300718</span>   <span class="token number">10</span>     <span class="token number">1</span>         <span class="token number">0</span>   <span class="token number">7</span>   swapper<span class="token operator">/</span><span class="token number">7</span>
<span class="token number">4302300728</span>   <span class="token number">10</span>     <span class="token number">1</span>         <span class="token number">0</span>   <span class="token number">7</span>   swapper<span class="token operator">/</span><span class="token number">7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>10 个时钟周期左右，swapper&#x2F;7 调度一次，共 5 次</p>
<h3 id="tasklet"><a href="#tasklet" class="headerlink" title="tasklet"></a>tasklet</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">jit_tasklet_fn</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">jit_data</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">jit_data</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> j <span class="token operator">=</span> jiffies<span class="token punctuation">;</span>
	<span class="token function">seq_printf</span><span class="token punctuation">(</span>data<span class="token operator">-></span>m<span class="token punctuation">,</span> <span class="token string">"%9li  %3li     %i    %6i   %i   %s\n"</span><span class="token punctuation">,</span>
			     j<span class="token punctuation">,</span> j <span class="token operator">-</span> data<span class="token operator">-></span>prevjiffies<span class="token punctuation">,</span> <span class="token function">in_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			     current<span class="token operator">-></span>pid<span class="token punctuation">,</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>data<span class="token operator">-></span>loops<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		data<span class="token operator">-></span>prevjiffies <span class="token operator">=</span> j<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>hi<span class="token punctuation">)</span>
			<span class="token function">tasklet_hi_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>tlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token function">tasklet_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>tlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* the /proc function: allocate everything to allow concurrency */</span>
<span class="token keyword">int</span> <span class="token function">jit_tasklet_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">jit_data</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> j <span class="token operator">=</span> jiffies<span class="token punctuation">;</span>
	<span class="token keyword">long</span> hi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>m<span class="token operator">-></span>private<span class="token punctuation">;</span>

	data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* write the first lines in the buffer */</span>
	<span class="token function">seq_puts</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"   time   delta  inirq    pid   cpu command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">seq_printf</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"%9li  %3li     %i    %6i   %i   %s\n"</span><span class="token punctuation">,</span>
			j<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token function">in_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			current<span class="token operator">-></span>pid<span class="token punctuation">,</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* fill the data for our tasklet function */</span>
	data<span class="token operator">-></span>prevjiffies <span class="token operator">=</span> j<span class="token punctuation">;</span>
	data<span class="token operator">-></span>m <span class="token operator">=</span> m<span class="token punctuation">;</span>
	data<span class="token operator">-></span>loops <span class="token operator">=</span> JIT_ASYNC_LOOPS<span class="token punctuation">;</span>

	<span class="token comment">/* register the tasklet */</span>
	<span class="token function">tasklet_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>tlet<span class="token punctuation">,</span> jit_tasklet_fn<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	data<span class="token operator">-></span>hi <span class="token operator">=</span> hi<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>hi<span class="token punctuation">)</span>
		<span class="token function">tasklet_hi_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>tlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token function">tasklet_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-></span>tlet<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* wait for the buffer to fill */</span>
	<span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>data<span class="token operator">-></span>wait<span class="token punctuation">,</span> <span class="token operator">!</span>data<span class="token operator">-></span>loops<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>result</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">rt@rogerthat <span class="token operator">~</span><span class="token operator">/</span>k<span class="token operator">/</span>l<span class="token operator">/</span>misc<span class="token operator">-</span><span class="token function">modules</span> <span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token operator">></span> cat <span class="token operator">/</span>proc<span class="token operator">/</span>jitasklet 
   time   delta  inirq    pid   cpu command
<span class="token number">4302528075</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">49279</span>   <span class="token number">5</span>   cat
<span class="token number">4302528075</span>    <span class="token number">0</span>     <span class="token number">1</span>        <span class="token number">47</span>   <span class="token number">5</span>   ksoftirqd<span class="token operator">/</span><span class="token number">5</span>
<span class="token number">4302528075</span>    <span class="token number">0</span>     <span class="token number">1</span>        <span class="token number">47</span>   <span class="token number">5</span>   ksoftirqd<span class="token operator">/</span><span class="token number">5</span>
<span class="token number">4302528075</span>    <span class="token number">0</span>     <span class="token number">1</span>        <span class="token number">47</span>   <span class="token number">5</span>   ksoftirqd<span class="token operator">/</span><span class="token number">5</span>
<span class="token number">4302528075</span>    <span class="token number">0</span>     <span class="token number">1</span>        <span class="token number">47</span>   <span class="token number">5</span>   ksoftirqd<span class="token operator">/</span><span class="token number">5</span>
<span class="token number">4302528075</span>    <span class="token number">0</span>     <span class="token number">1</span>        <span class="token number">47</span>   <span class="token number">5</span>   ksoftirqd<span class="token operator">/</span><span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="第八章"><a href="#第八章" class="headerlink" title="第八章"></a>第八章</h2><p>命名 <code>scullo</code>，抄袭 <code>GPT4o</code> 命名方式</p>
<h3 id="scullo-改改改？！"><a href="#scullo-改改改？！" class="headerlink" title="scullo 改改改？！"></a>scullo 改改改？！</h3><p>先说结论，踩雷</p>
<blockquote>
<p>Linux内核有一个usercopy whitelist机制，只允许这里面的region来做usercopy。如果是用kmem_cache_create申请的kmem_cache申请的内存空间来copy to user或者copy from user，那么就会报这个错。这时要用kmem_cache_create_usercopy，来将申请的区域加入到usercopy whitelist中。</p>
<p>kmem_cache_create_usercopy的参数中offset是指region相对于申请的内存的首地址的偏移量。如果整个区域都是，那么就设置为0。</p>
</blockquote>
<p>核心的分配代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv<span class="token punctuation">)</span>
	dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">vmalloc</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">&lt;&lt;</span> dptr<span class="token operator">-></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
	dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">__get_free_pages</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> dptr<span class="token operator">-></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
	dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>scullo_cache<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>核心的释放代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv<span class="token punctuation">)</span>
		<span class="token function">vfree</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
		<span class="token function">free_pages</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dptr<span class="token operator">-></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
		<span class="token function">kmem_cache_free</span><span class="token punctuation">(</span>scullo_cache<span class="token punctuation">,</span> dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完整代码，基本就是找找 diff，改改改了，没有太大区别，就是 <code>scullc </code>有一些接口不支持了，比如 <code>.nopage</code></p>
<h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* -*- C -*-
 * main.c -- the bare scullo char module
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 *
 * $Id: _main.c.in,v 1.21 2004/10/14 20:11:39 corbet Exp $
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/moduleparam.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span>	<span class="token comment">/* printk() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span>		<span class="token comment">/* kmalloc() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>		<span class="token comment">/* everything... */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span>	<span class="token comment">/* error codes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span>	<span class="token comment">/* size_t */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/seq_file.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span>	<span class="token comment">/* O_ACCMODE */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/aio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uio.h></span>	<span class="token comment">/* ivo_iter* */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/vmalloc.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scull-shared/scull-async.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scullo.h"</span>		<span class="token comment">/* local definitions */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"access_ok_version.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"proc_ops_version.h"</span></span>

<span class="token keyword">int</span> scullo_major <span class="token operator">=</span>   SCULLO_MAJOR<span class="token punctuation">;</span>
<span class="token keyword">int</span> scullo_devs <span class="token operator">=</span>    SCULLO_DEVS<span class="token punctuation">;</span>	<span class="token comment">/* number of bare scullo devices */</span>
<span class="token keyword">int</span> scullo_qset <span class="token operator">=</span>    SCULLO_QSET<span class="token punctuation">;</span>
<span class="token keyword">int</span> scullo_quantum <span class="token operator">=</span> SCULLO_QUANTUM<span class="token punctuation">;</span>

<span class="token keyword">int</span> scullo_order <span class="token operator">=</span>   <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> scullp_order <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> scullv_order <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> scullo_type <span class="token operator">=</span> scullv<span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>scullo_type<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scullo_major<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scullo_devs<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scullo_qset<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scullo_order<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scullo_quantum<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"Alessandro Rubini"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>scullo_devices<span class="token punctuation">;</span> <span class="token comment">/* allocated in scullo_init */</span>

<span class="token keyword">int</span> <span class="token function">scullo_trim</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">scullo_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* declare one cache pointer: use it for all devices */</span>
<span class="token keyword">struct</span> <span class="token class-name">kmem_cache</span> <span class="token operator">*</span>scullo_cache<span class="token punctuation">;</span>




<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULLO_USE_PROC </span><span class="token comment">/* don't waste space if unused */</span></span>
<span class="token comment">/*
 * The proc filesystem: function to read and entry
 */</span>

<span class="token comment">/* FIXME: Do we need this here??  It be ugly  */</span>
<span class="token keyword">int</span> <span class="token function">scullo_read_procmem</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> quantum<span class="token punctuation">,</span> order<span class="token punctuation">,</span> qset<span class="token punctuation">;</span>
	<span class="token keyword">int</span> limit <span class="token operator">=</span> m<span class="token operator">-></span>size <span class="token operator">-</span> <span class="token number">80</span><span class="token punctuation">;</span> <span class="token comment">/* Don't print more than this */</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>d<span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scullo_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		d <span class="token operator">=</span> <span class="token operator">&amp;</span>scullo_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mutex_lock_interruptible</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
		qset <span class="token operator">=</span> d<span class="token operator">-></span>qset<span class="token punctuation">;</span>  <span class="token comment">/* retrieve the features of each device */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			order <span class="token operator">=</span> d<span class="token operator">-></span>order<span class="token punctuation">;</span>
			<span class="token function">seq_printf</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token string">"\nDevice %i: qset %i, order %i, sz %li\n"</span><span class="token punctuation">,</span>
					i<span class="token punctuation">,</span> qset<span class="token punctuation">,</span> order<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>d<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			quantum <span class="token operator">=</span> d<span class="token operator">-></span>quantum<span class="token punctuation">;</span>
			<span class="token function">seq_printf</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token string">"\nDevice %i: qset %i, quantum %i, sz %li\n"</span><span class="token punctuation">,</span>
					i<span class="token punctuation">,</span> qset<span class="token punctuation">,</span> quantum<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>d<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> d<span class="token punctuation">;</span> d <span class="token operator">=</span> d<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* scan the list */</span>
			<span class="token function">seq_printf</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token string">"  item at %p, qset at %p\n"</span><span class="token punctuation">,</span>d<span class="token punctuation">,</span>d<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span>count <span class="token operator">></span> limit<span class="token punctuation">)</span>
				<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>d<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token comment">/* dump only the last item - save space */</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> qset<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
						<span class="token function">seq_printf</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token string">"    % 4i:%8p\n"</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>d<span class="token operator">-></span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span>count <span class="token operator">></span> limit<span class="token punctuation">)</span>
						<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	  out<span class="token operator">:</span>
		<span class="token function">mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>scullo_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span>count <span class="token operator">></span> limit<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scullo_proc_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">single_open</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> scullo_read_procmem<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scullo_proc_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> scullo_proc_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> seq_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>llseek <span class="token operator">=</span> seq_lseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> single_release
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* SCULLO_USE_PROC */</span></span>

<span class="token comment">/*
 * Open and close
 */</span>

<span class="token keyword">int</span> <span class="token function">scullo_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

	<span class="token comment">/*  Find the device */</span>
	dev <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_cdev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span><span class="token punctuation">,</span> cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    	<span class="token comment">/* now trim to 0 the length of the device if open was write-only */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mutex_lock_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
		<span class="token function">scullo_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* ignore errors */</span>
		<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/* and use filp->private_data to point to the device data */</span>
	filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">scullo_release</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Follow the list 
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span><span class="token function">scullo_follow</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			dev<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>next<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		dev <span class="token operator">=</span> dev<span class="token operator">-></span>next<span class="token punctuation">;</span>
		<span class="token keyword">continue</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> dev<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Data management: read and write
 */</span>

<span class="token class-name">ssize_t</span> <span class="token function">scullo_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
                <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span> <span class="token comment">/* the first listitem */</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> quantum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		quantum <span class="token operator">=</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> dev<span class="token operator">-></span>order<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		quantum <span class="token operator">=</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">int</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>
	<span class="token keyword">int</span> itemsize <span class="token operator">=</span> quantum <span class="token operator">*</span> qset<span class="token punctuation">;</span> <span class="token comment">/* how many bytes in the listitem */</span>
	<span class="token keyword">int</span> item<span class="token punctuation">,</span> s_pos<span class="token punctuation">,</span> q_pos<span class="token punctuation">,</span> rest<span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mutex_lock_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>f_pos <span class="token operator">></span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span> 
		<span class="token keyword">goto</span> nothing<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>f_pos <span class="token operator">+</span> count <span class="token operator">></span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span>
		count <span class="token operator">=</span> dev<span class="token operator">-></span>size <span class="token operator">-</span> <span class="token operator">*</span>f_pos<span class="token punctuation">;</span>
	<span class="token comment">/* find listitem, qset index, and offset in the quantum */</span>
	item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token operator">/</span> itemsize<span class="token punctuation">;</span>
	rest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token operator">%</span> itemsize<span class="token punctuation">;</span>
	s_pos <span class="token operator">=</span> rest <span class="token operator">/</span> quantum<span class="token punctuation">;</span> q_pos <span class="token operator">=</span> rest <span class="token operator">%</span> quantum<span class="token punctuation">;</span>

    	<span class="token comment">/* follow the list up to the right position (defined elsewhere) */</span>
	dptr <span class="token operator">=</span> <span class="token function">scullo_follow</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> nothing<span class="token punctuation">;</span> <span class="token comment">/* don't fill holes */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> nothing<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">)</span>
		count <span class="token operator">=</span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">;</span> <span class="token comment">/* read only up to the end of this quantum */</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token operator">+</span>q_pos<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		retval <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> nothing<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token operator">*</span>f_pos <span class="token operator">+=</span> count<span class="token punctuation">;</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>

  nothing<span class="token operator">:</span>
	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>



<span class="token class-name">ssize_t</span> <span class="token function">scullo_write</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
                <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> quantum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		quantum <span class="token operator">=</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> dev<span class="token operator">-></span>order<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		quantum <span class="token operator">=</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">int</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>
	<span class="token keyword">int</span> itemsize <span class="token operator">=</span> quantum <span class="token operator">*</span> qset<span class="token punctuation">;</span>
	<span class="token keyword">int</span> item<span class="token punctuation">,</span> s_pos<span class="token punctuation">,</span> q_pos<span class="token punctuation">,</span> rest<span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span> <span class="token comment">/* our most likely error */</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mutex_lock_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>

	<span class="token comment">/* find listitem, qset index and offset in the quantum */</span>
	item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token operator">/</span> itemsize<span class="token punctuation">;</span>
	rest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token operator">%</span> itemsize<span class="token punctuation">;</span>
	s_pos <span class="token operator">=</span> rest <span class="token operator">/</span> quantum<span class="token punctuation">;</span> q_pos <span class="token operator">=</span> rest <span class="token operator">%</span> quantum<span class="token punctuation">;</span>

	<span class="token comment">/* follow the list up to the right position */</span>
	dptr <span class="token operator">=</span> <span class="token function">scullo_follow</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		dptr<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>qset <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> nomem<span class="token punctuation">;</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> qset <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">/* Allocate a quantum using virtual addresses */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv<span class="token punctuation">)</span>
			dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">vmalloc</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">&lt;&lt;</span> dptr<span class="token operator">-></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
			dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">__get_free_pages</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> dptr<span class="token operator">-></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
			dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>scullo_cache<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token keyword">goto</span> nomem<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PAGE_SIZE <span class="token operator">&lt;&lt;</span> dptr<span class="token operator">-></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Test1.1 %d %p\n"</span><span class="token punctuation">,</span> scullo_quantum<span class="token punctuation">,</span> dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scullo_quantum<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">)</span>
		count <span class="token operator">=</span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">;</span> <span class="token comment">/* write only up to the end of this quantum */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span> <span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token operator">+</span>q_pos<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		retval <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> nomem<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">*</span>f_pos <span class="token operator">+=</span> count<span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Test4\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    	<span class="token comment">/* update the size */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>size <span class="token operator">&lt;</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
		dev<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token operator">*</span>f_pos<span class="token punctuation">;</span>
	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>

  nomem<span class="token operator">:</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The ioctl() implementation
 */</span>

<span class="token keyword">long</span> <span class="token function">scullo_ioctl</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tmp<span class="token punctuation">;</span>

	<span class="token comment">/* don't even decode wrong cmds: better returning  ENOTTY than EFAULT */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_TYPE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">!=</span> SCULLO_IOC_MAGIC<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_NR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">></span> SCULLO_IOC_MAXNR<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * the type is a bitmask, and VERIFY_WRITE catches R/W
	 * transfers. Note that the type is user-oriented, while
	 * verify_area is kernel-oriented, so the concept of "read" and
	 * "write" is reversed
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_DIR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">&amp;</span> _IOC_READ<span class="token punctuation">)</span>
		err <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">access_ok_wrapper</span><span class="token punctuation">(</span>VERIFY_WRITE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_DIR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">&amp;</span> _IOC_WRITE<span class="token punctuation">)</span>
		err <span class="token operator">=</span>  <span class="token operator">!</span><span class="token function">access_ok_wrapper</span><span class="token punctuation">(</span>VERIFY_READ<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">case</span> SCULLO_IOCRESET<span class="token operator">:</span>
		scullo_qset <span class="token operator">=</span> SCULLO_QSET<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv<span class="token punctuation">)</span>
			scullo_order <span class="token operator">=</span> scullv_order<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
			scullo_order <span class="token operator">=</span> scullp_order<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
			scullo_quantum <span class="token operator">=</span> SCULLO_QUANTUM<span class="token punctuation">;</span>	
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCSORDER<span class="token operator">:</span> <span class="token comment">/* Set: arg points to the value */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
			ret <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scullo_order<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
			ret <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scullo_quantum<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCTORDER<span class="token operator">:</span> <span class="token comment">/* Tell: arg is the value */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
			scullo_order <span class="token operator">=</span> arg<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
			scullo_quantum <span class="token operator">=</span> arg<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCGORDER<span class="token operator">:</span> <span class="token comment">/* Get: arg is pointer to result */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
			ret <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>scullo_order<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
			ret <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>scullo_quantum<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCQORDER<span class="token operator">:</span> <span class="token comment">/* Query: return it (it's positive) */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
			<span class="token keyword">return</span> scullo_order<span class="token punctuation">;</span>
		<span class="token keyword">else</span> 
			<span class="token keyword">return</span> scullo_quantum<span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCXORDER<span class="token operator">:</span> <span class="token comment">/* eXchange: use arg as pointer */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			tmp <span class="token operator">=</span> scullo_order<span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scullo_order<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			tmp <span class="token operator">=</span> scullo_quantum<span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scullo_quantum<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCHORDER<span class="token operator">:</span> <span class="token comment">/* sHift: like Tell + Query */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			tmp <span class="token operator">=</span> scullo_order<span class="token punctuation">;</span>
			scullo_order <span class="token operator">=</span> arg<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			tmp <span class="token operator">=</span> scullo_quantum<span class="token punctuation">;</span>
			scullo_quantum <span class="token operator">=</span> arg<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> tmp<span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCSQSET<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scullo_qset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCTQSET<span class="token operator">:</span>
		scullo_qset <span class="token operator">=</span> arg<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCGQSET<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>scullo_qset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCQQSET<span class="token operator">:</span>
		<span class="token keyword">return</span> scullo_qset<span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCXQSET<span class="token operator">:</span>
		tmp <span class="token operator">=</span> scullo_qset<span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scullo_qset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			ret <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> SCULLO_IOCHQSET<span class="token operator">:</span>
		tmp <span class="token operator">=</span> scullo_qset<span class="token punctuation">;</span>
		scullo_qset <span class="token operator">=</span> arg<span class="token punctuation">;</span>
		<span class="token keyword">return</span> tmp<span class="token punctuation">;</span>

	<span class="token keyword">default</span><span class="token operator">:</span>  <span class="token comment">/* redundant, as cmd was checked against MAXNR */</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The "extended" operations
 */</span>

<span class="token class-name">loff_t</span> <span class="token function">scullo_llseek</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">long</span> newpos<span class="token punctuation">;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>whence<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">/* SEEK_SET */</span>
		newpos <span class="token operator">=</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">/* SEEK_CUR */</span>
		newpos <span class="token operator">=</span> filp<span class="token operator">-></span>f_pos <span class="token operator">+</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token comment">/* SEEK_END */</span>
		newpos <span class="token operator">=</span> dev<span class="token operator">-></span>size <span class="token operator">+</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">/* can't happen */</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>newpos<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	filp<span class="token operator">-></span>f_pos <span class="token operator">=</span> newpos<span class="token punctuation">;</span>
	<span class="token keyword">return</span> newpos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Mmap *is* available, but confined in a different file
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">scullo_mmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">/*
 * The fops
 */</span>

<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scullo_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span>     THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>llseek <span class="token operator">=</span>    scullo_llseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span>	     scullo_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span>     scullo_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> scullo_ioctl<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>mmap <span class="token operator">=</span>	     scullo_mmap<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span>	     scullo_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span>   scullo_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read_iter <span class="token operator">=</span>  scull_read_iter<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write_iter <span class="token operator">=</span> scull_write_iter<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">scullo_trim</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>   <span class="token comment">/* "dev" is not-null */</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>vmas<span class="token punctuation">)</span> <span class="token comment">/* don't trim: there are active mappings */</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>dptr <span class="token operator">=</span> dev<span class="token punctuation">;</span> dptr<span class="token punctuation">;</span> dptr <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* all the list items */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">/* Release the quantum-set */</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> qset<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv<span class="token punctuation">)</span>
						<span class="token function">vfree</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
						<span class="token function">free_pages</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dptr<span class="token operator">-></span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
						<span class="token function">kmem_cache_free</span><span class="token punctuation">(</span>scullo_cache<span class="token punctuation">,</span> dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			dptr<span class="token operator">-></span>data<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		next<span class="token operator">=</span>dptr<span class="token operator">-></span>next<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>dptr <span class="token operator">!=</span> dev<span class="token punctuation">)</span> <span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* all of them but the first */</span>
	<span class="token punctuation">&#125;</span>
	dev<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	dev<span class="token operator">-></span>qset <span class="token operator">=</span> scullo_qset<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span>
		dev<span class="token operator">-></span>order <span class="token operator">=</span> scullo_order<span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span>
		dev<span class="token operator">-></span>quantum <span class="token operator">=</span> scullo_quantum<span class="token punctuation">;</span>
	dev<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scullo_setup_cdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">,</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scullo_major<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scullo_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>scullo_fops<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	err <span class="token operator">=</span> <span class="token function">cdev_add</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Fail gracefully if need be */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"Error %d adding scull%d"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>



<span class="token comment">/*
 * Finally, the module stuff
 */</span>

<span class="token keyword">int</span> <span class="token function">scullo_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> dev <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scullo_major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*
	 * Register your major, and accept a dynamic number.
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_major<span class="token punctuation">)</span>
		result <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> scullo_devs<span class="token punctuation">,</span> <span class="token string">"scullo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		result <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scullo_devs<span class="token punctuation">,</span> <span class="token string">"scullo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		scullo_major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>

	
	<span class="token comment">/* 
	 * allocate the devices -- we can't have them static, as the number
	 * can be specified at load time
	 */</span>
	scullo_devices <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>scullo_devs<span class="token operator">*</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scullo_devices<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		result <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> fail_malloc<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>scullo_devices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scullo_devs<span class="token operator">*</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scullo_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv <span class="token operator">||</span> scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			scullo_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>order <span class="token operator">=</span> scullo_order<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			scullo_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>quantum <span class="token operator">=</span> scullo_quantum<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		scullo_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>qset <span class="token operator">=</span> scullo_qset<span class="token punctuation">;</span>
		<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scullo_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">scullo_setup_cdev</span><span class="token punctuation">(</span>scullo_devices <span class="token operator">+</span> i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// scullo_cache = kmem_cache_create("scullo", scullo_quantum, 0, SLAB_HWCACHE_ALIGN, NULL);</span>
		scullo_cache <span class="token operator">=</span> <span class="token function">kmem_cache_create_usercopy</span><span class="token punctuation">(</span><span class="token string">"scullo"</span><span class="token punctuation">,</span> scullo_quantum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> SLAB_HWCACHE_ALIGN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scullo_quantum<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* no ctor/dtor */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scullo_cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">scullo_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULLO_USE_PROC </span><span class="token comment">/* only when available */</span></span>
	<span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token string">"scullomem"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">proc_ops_wrapper</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scullo_proc_ops<span class="token punctuation">,</span> scullo_pops<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* succeed */</span>

  fail_malloc<span class="token operator">:</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> scullo_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">void</span> <span class="token function">scullo_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULLO_USE_PROC</span></span>
	<span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"scullomem"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scullo_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scullo_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">scullo_trim</span><span class="token punctuation">(</span>scullo_devices <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>scullo_devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullc <span class="token operator">&amp;&amp;</span> scullo_cache<span class="token punctuation">)</span>
		<span class="token function">kmem_cache_destroy</span><span class="token punctuation">(</span>scullo_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token function">MKDEV</span> <span class="token punctuation">(</span>scullo_major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scullo_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token function">module_init</span><span class="token punctuation">(</span>scullo_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>scullo_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="mmap-c"><a href="#mmap-c" class="headerlink" title="mmap.c"></a>mmap.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*  -*- C -*-
 * mmap.c -- memory mapping for the scullo char module
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 *
 * $Id: _mmap.c.in,v 1.13 2004/10/18 18:07:36 corbet Exp $
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h></span>		<span class="token comment">/* everything */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span>	<span class="token comment">/* error codes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/pgtable.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scullo.h"</span>		<span class="token comment">/* local definitions */</span></span>


<span class="token comment">/*
 * open and close: just keep track of how many times the device is
 * mapped, to avoid releasing it.
 */</span>

<span class="token keyword">void</span> <span class="token function">scullo_vma_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> vma<span class="token operator">-></span>vm_private_data<span class="token punctuation">;</span>

	dev<span class="token operator">-></span>vmas<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">scullo_vma_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> vma<span class="token operator">-></span>vm_private_data<span class="token punctuation">;</span>

	dev<span class="token operator">-></span>vmas<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The nopage method: the core of the file. It retrieves the
 * page required from the scullo device and returns it to the
 * user. The count for the page must be incremented, because
 * it is automatically decremented at page unmap.
 *
 * For this reason, "order" must be zero. Otherwise, only the first
 * page has its count incremented, and the allocating module must
 * release it as a whole block. Therefore, it isn't possible to map
 * pages from a multipage block: when they are unmapped, their count
 * is individually decreased, and would drop to 0.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LINUX_VERSION_CODE <span class="token operator">&lt;</span> <span class="token function">KERNEL_VERSION</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token class-name">vm_fault_t</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token class-name">vm_fault_t</span> <span class="token function">scullo_vma_nopage</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">vm_fault</span> <span class="token operator">*</span>vmf<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> offset<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma <span class="token operator">=</span> vmf<span class="token operator">-></span>vma<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span>dev <span class="token operator">=</span> vma<span class="token operator">-></span>vm_private_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>pageptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* default to "missing" */</span>
	<span class="token class-name">vm_fault_t</span> retval <span class="token operator">=</span> VM_FAULT_NOPAGE<span class="token punctuation">;</span>

	<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>vmf<span class="token operator">-></span>address <span class="token operator">-</span> vma<span class="token operator">-></span>vm_start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_pgoff <span class="token operator">&lt;&lt;</span> PAGE_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token keyword">goto</span> out<span class="token punctuation">;</span> <span class="token comment">/* out of range */</span>

	<span class="token comment">/*
	 * Now retrieve the scullo device from the list,then the page.
	 * If the device has holes, the process receives a SIGBUS when
	 * accessing the hole.
	 */</span>
	offset <span class="token operator">>>=</span> PAGE_SHIFT<span class="token punctuation">;</span> <span class="token comment">/* offset is a number of pages */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>ptr <span class="token operator">=</span> dev<span class="token punctuation">;</span> ptr <span class="token operator">&amp;&amp;</span> offset <span class="token operator">>=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ptr <span class="token operator">=</span> ptr<span class="token operator">-></span>next<span class="token punctuation">;</span>
		offset <span class="token operator">-=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">&amp;&amp;</span> ptr<span class="token operator">-></span>data<span class="token punctuation">)</span> pageptr <span class="token operator">=</span> ptr<span class="token operator">-></span>data<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pageptr<span class="token punctuation">)</span> <span class="token keyword">goto</span> out<span class="token punctuation">;</span> <span class="token comment">/* hole or end-of-file */</span>

	<span class="token comment">/*
	 * After scullo lookup, "page" is now the address of the page
	 * needed by the current process. Since it's a vmalloc address,
	 * turn it into a struct page.
	 */</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		page <span class="token operator">=</span> <span class="token function">vmalloc_to_page</span><span class="token punctuation">(</span>pageptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_type <span class="token operator">==</span> scullp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		page <span class="token operator">=</span> <span class="token function">virt_to_page</span><span class="token punctuation">(</span>pageptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/* got it, now increment the count */</span>
	<span class="token function">get_page</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
	vmf<span class="token operator">-></span>page <span class="token operator">=</span> page<span class="token punctuation">;</span>
	retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  out<span class="token operator">:</span>
	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">struct</span> <span class="token class-name">vm_operations_struct</span> scullo_vm_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span>     scullo_vma_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>close <span class="token operator">=</span>    scullo_vma_close<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>fault <span class="token operator">=</span>    scullo_vma_nopage<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// struct vm_operations_struct scullc_vm_ops = &#123;</span>
<span class="token comment">// 	.open =     scullo_vma_open,</span>
<span class="token comment">// 	.close =    scullo_vma_close,</span>
<span class="token comment">// 	.nopage =    scullc_vma_nopage,</span>
<span class="token comment">// &#125;;</span>

<span class="token keyword">int</span> <span class="token function">scullo_mmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode <span class="token operator">=</span> filp<span class="token operator">-></span>f_path<span class="token punctuation">.</span>dentry<span class="token operator">-></span>d_inode<span class="token punctuation">;</span>
	
	<span class="token comment">/* refuse to map if order is not 0 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scullo_devices<span class="token punctuation">[</span><span class="token function">iminor</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>order<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>


	vma<span class="token operator">-></span>vm_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>scullo_vm_ops<span class="token punctuation">;</span>
	vma<span class="token operator">-></span>vm_private_data <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token function">scullo_vma_open</span><span class="token punctuation">(</span>vma<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="scullo-h"><a href="#scullo-h" class="headerlink" title="scullo.h"></a>scullo.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* -*- C -*-
 * scullo.h -- definitions for the scullo char module
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioctl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/semaphore.h></span></span>

<span class="token comment">/*
 * Macros to help debugging
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">PDEBUG             </span><span class="token comment">/* undef it, just in case */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULLO_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">ifdef</span> <span class="token expression">__KERNEL__</span></span>
     <span class="token comment">/* This one if debugging is on, and kernel space */</span>
<span class="token macro property"><span class="token directive-hash">#</span>    <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">printk</span><span class="token punctuation">(</span> KERN_DEBUG </span><span class="token string">"scullo: "</span> <span class="token expression">fmt<span class="token punctuation">,</span> </span><span class="token punctuation">##</span> <span class="token expression">args<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">else</span></span>
     <span class="token comment">/* This one for user space */</span>
<span class="token macro property"><span class="token directive-hash">#</span>    <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> </span><span class="token punctuation">##</span> <span class="token expression">args<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token comment">/* not debugging: nothing */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">PDEBUGG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUGG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token comment">/* nothing: it's a placeholder */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_MAJOR</span> <span class="token expression"><span class="token number">0</span>   </span><span class="token comment">/* dynamic major by default */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_DEVS</span> <span class="token expression"><span class="token number">4</span>    </span><span class="token comment">/* scullo0 through scullo3 */</span></span>

<span class="token comment">/*
 * The bare device is a variable-length region of memory.
 * Use a linked list of indirect blocks.
 *
 * "scullo_dev->data" points to an array of pointers, each
 * pointer refers to a memory page.
 *
 * The array (quantum-set) is SCULLO_QSET long.
 */</span>
<span class="token comment">// #define SCULLO_ORDER    4 /* 16 pages at a time */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_QUANTUM</span>  <span class="token expression"><span class="token number">4000</span> </span><span class="token comment">/* use a quantum size like scull */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_QSET</span>     <span class="token expression"><span class="token number">500</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>  <span class="token comment">/* next listitem */</span>
	<span class="token keyword">int</span> vmas<span class="token punctuation">;</span>                 <span class="token comment">/* active mappings */</span>
	<span class="token keyword">int</span> order<span class="token punctuation">;</span>                <span class="token comment">/* the current allocation order */</span>
	<span class="token keyword">int</span> quantum<span class="token punctuation">;</span>              <span class="token comment">/* the current allocation size */</span>
	<span class="token keyword">int</span> qset<span class="token punctuation">;</span>                 <span class="token comment">/* the current array size */</span>
	<span class="token class-name">size_t</span> size<span class="token punctuation">;</span>              <span class="token comment">/* 32-bit will suffice */</span>
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span> mutex<span class="token punctuation">;</span>     <span class="token comment">/* Mutual exclusion */</span>
	<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>scullo_devices<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scullo_fops<span class="token punctuation">;</span>

<span class="token comment">/*
 * The different configurable parameters
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scullo_major<span class="token punctuation">;</span>     <span class="token comment">/* main.c */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scullo_devs<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scullo_order<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scullo_qset<span class="token punctuation">;</span>


<span class="token keyword">enum</span> <span class="token class-name">scull_type</span><span class="token punctuation">&#123;</span>
	scullc<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
	scullp<span class="token punctuation">,</span>
	scullv<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token keyword">int</span> scullo_type<span class="token punctuation">;</span>

<span class="token comment">/*
 * Prototypes for shared functions
 */</span>
<span class="token keyword">int</span> <span class="token function">scullo_trim</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span><span class="token function">scullo_follow</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scullo_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULLO_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_USE_PROC</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * Ioctl definitions
 */</span>

<span class="token comment">/* Use 'K' as magic number */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOC_MAGIC</span>  <span class="token char">'K'</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCRESET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*
 * S means "Set" through a ptr,
 * T means "Tell" directly
 * G means "Get" (to a pointed var)
 * Q means "Query", response is on the return value
 * X means "eXchange": G and S atomically
 * H means "sHift": T and Q atomically
 */</span>
<span class="token comment">// // for scullc</span>
<span class="token comment">// #define SCULLO_IOCSQUANTUM _IOW(SCULLO_IOC_MAGIC,  1, int)</span>
<span class="token comment">// #define SCULLO_IOCTQUANTUM _IO(SCULLO_IOC_MAGIC,   2)</span>
<span class="token comment">// #define SCULLO_IOCGQUANTUM _IOR(SCULLO_IOC_MAGIC,  3, int)</span>
<span class="token comment">// #define SCULLO_IOCQQUANTUM _IO(SCULLO_IOC_MAGIC,   4)</span>
<span class="token comment">// #define SCULLO_IOCXQUANTUM _IOWR(SCULLO_IOC_MAGIC, 5, int)</span>
<span class="token comment">// #define SCULLO_IOCHQUANTUM _IO(SCULLO_IOC_MAGIC,   6)</span>
<span class="token comment">// for scullp &amp;&amp; scullv</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCSORDER</span>   <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCTORDER</span>   <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">2</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCGORDER</span>   <span class="token expression"><span class="token function">_IOR</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCQORDER</span>   <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCXORDER</span>   <span class="token expression"><span class="token function">_IOWR</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCHORDER</span>   <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">6</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCSQSET</span>    <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCTQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCGQSET</span>    <span class="token expression"><span class="token function">_IOR</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCQQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">10</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCXQSET</span>    <span class="token expression"><span class="token function">_IOWR</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOCHQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULLO_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">12</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULLO_IOC_MAXNR</span> <span class="token expression"><span class="token number">12</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Comment<span class="token operator">/</span>uncomment the following line to enable<span class="token operator">/</span>disable debugging</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">DEBUG <span class="token operator">=</span> y</span></span>


<span class="token function">ifeq</span> <span class="token punctuation">(</span>$<span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  DEBFLAGS <span class="token operator">=</span> <span class="token operator">-</span>O <span class="token operator">-</span>g <span class="token operator">-</span>DSCULLO_DEBUG # <span class="token string">"-O"</span> is needed to expand inlines
<span class="token keyword">else</span>
  DEBFLAGS <span class="token operator">=</span> <span class="token operator">-</span>O2
endif

LDDINC<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>include
EXTRA_CFLAGS <span class="token operator">+=</span> $<span class="token punctuation">(</span>DEBFLAGS<span class="token punctuation">)</span> <span class="token operator">-</span>I$<span class="token punctuation">(</span>LDDINC<span class="token punctuation">)</span>

TARGET <span class="token operator">=</span> scullo

<span class="token function">ifneq</span> <span class="token punctuation">(</span>$<span class="token punctuation">(</span>KERNELRELEASE<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span>

scullo<span class="token operator">-</span>objs <span class="token operator">:</span><span class="token operator">=</span> main<span class="token punctuation">.</span>o mmap<span class="token punctuation">.</span>o scull<span class="token operator">-</span>shared<span class="token operator">/</span>scull<span class="token operator">-</span>async<span class="token punctuation">.</span>o

obj<span class="token operator">-</span>m	<span class="token operator">:</span><span class="token operator">=</span> scullo<span class="token punctuation">.</span>o

<span class="token keyword">else</span>

KERNELDIR <span class="token operator">?</span><span class="token operator">=</span> <span class="token operator">/</span>lib<span class="token operator">/</span>modules<span class="token operator">/</span>$<span class="token punctuation">(</span>shell uname <span class="token operator">-</span>r<span class="token punctuation">)</span><span class="token operator">/</span>build
PWD       <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span>

modules<span class="token operator">:</span>
	$<span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERNELDIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules

endif


install<span class="token operator">:</span>
	install <span class="token operator">-</span>d $<span class="token punctuation">(</span>INSTALLDIR<span class="token punctuation">)</span>
	install <span class="token operator">-</span>c $<span class="token punctuation">(</span>TARGET<span class="token punctuation">)</span><span class="token punctuation">.</span>o $<span class="token punctuation">(</span>INSTALLDIR<span class="token punctuation">)</span>

clean<span class="token operator">:</span>
	rm <span class="token operator">-</span>rf <span class="token operator">*</span><span class="token punctuation">.</span>o <span class="token operator">*</span><span class="token operator">~</span> core <span class="token punctuation">.</span>depend <span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>cmd <span class="token operator">*</span><span class="token punctuation">.</span>ko <span class="token operator">*</span><span class="token punctuation">.</span>mod<span class="token punctuation">.</span>c <span class="token punctuation">.</span>tmp_versions <span class="token operator">*</span><span class="token punctuation">.</span>mod modules<span class="token punctuation">.</span>order <span class="token operator">*</span><span class="token punctuation">.</span>symvers scull<span class="token operator">-</span>shared<span class="token operator">/</span>scull<span class="token operator">-</span>async<span class="token punctuation">.</span>o


depend <span class="token punctuation">.</span>depend dep<span class="token operator">:</span>
	$<span class="token punctuation">(</span>CC<span class="token punctuation">)</span> $<span class="token punctuation">(</span>EXTRA_CFLAGS<span class="token punctuation">)</span> <span class="token operator">-</span>M <span class="token operator">*</span><span class="token punctuation">.</span>c <span class="token operator">></span> <span class="token punctuation">.</span>depend

<span class="token function">ifeq</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>depend<span class="token punctuation">,</span>$<span class="token punctuation">(</span>wildcard <span class="token punctuation">.</span>depend<span class="token punctuation">)</span><span class="token punctuation">)</span>
include <span class="token punctuation">.</span>depend
endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="scullo-load-x2F-scullo-unload"><a href="#scullo-load-x2F-scullo-unload" class="headerlink" title="scullo_load&#x2F;scullo_unload"></a>scullo_load&#x2F;scullo_unload</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token assign-left variable">module</span><span class="token operator">=</span><span class="token string">"scullo"</span>
<span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token string">"scullo"</span>
<span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token string">"664"</span>

<span class="token comment"># Group: since distributions do it differently, look for wheel or use staff</span>
<span class="token keyword">if</span> <span class="token function">grep</span> <span class="token string">'^staff:'</span> /etc/group <span class="token operator">></span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token string">"staff"</span>
<span class="token keyword">else</span>
    <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token string">"wheel"</span>
<span class="token keyword">fi</span>

<span class="token comment"># remove stale nodes</span>
<span class="token function">rm</span> -f /dev/<span class="token variable">$&#123;device&#125;</span>? 

<span class="token comment"># invoke insmod with all arguments we got</span>
<span class="token comment"># and use a pathname, as newer modutils don't look in . by default</span>
insmod ./<span class="token variable">$module</span>.ko <span class="token variable">$*</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span>

<span class="token assign-left variable">major</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /proc/devices <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"<span class="token entity" title="\\">\\</span><span class="token variable">$2</span>==<span class="token entity" title="\&quot;">\"</span><span class="token variable">$module</span><span class="token entity" title="\&quot;">\"</span> &#123;print <span class="token entity" title="\\">\\</span><span class="token variable">$1</span>&#125;"</span><span class="token variable">`</span></span>

<span class="token function">mknod</span> /dev/<span class="token variable">$&#123;device&#125;</span><span class="token number">0</span> c <span class="token variable">$major</span> <span class="token number">0</span>
<span class="token function">mknod</span> /dev/<span class="token variable">$&#123;device&#125;</span><span class="token number">1</span> c <span class="token variable">$major</span> <span class="token number">1</span>
<span class="token function">mknod</span> /dev/<span class="token variable">$&#123;device&#125;</span><span class="token number">2</span> c <span class="token variable">$major</span> <span class="token number">2</span>
<span class="token function">mknod</span> /dev/<span class="token variable">$&#123;device&#125;</span><span class="token number">3</span> c <span class="token variable">$major</span> <span class="token number">3</span>
<span class="token function">ln</span> -sf <span class="token variable">$&#123;device&#125;</span><span class="token number">0</span>  /dev/<span class="token variable">$&#123;device&#125;</span>

<span class="token comment"># give appropriate group/permissions</span>
<span class="token function">chgrp</span> <span class="token variable">$group</span> /dev/<span class="token variable">$&#123;device&#125;</span><span class="token punctuation">[</span><span class="token number">0</span>-3<span class="token punctuation">]</span>
<span class="token function">chmod</span> <span class="token variable">$mode</span>  /dev/<span class="token variable">$&#123;device&#125;</span><span class="token punctuation">[</span><span class="token number">0</span>-3<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token assign-left variable">module</span><span class="token operator">=</span><span class="token string">"scullo"</span>
<span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token string">"scullo"</span>

<span class="token comment"># invoke rmmod with all arguments we got</span>
rmmod <span class="token variable">$module</span> <span class="token variable">$*</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span>

<span class="token comment"># remove nodes</span>
<span class="token function">rm</span> -f /dev/<span class="token variable">$&#123;device&#125;</span><span class="token punctuation">[</span><span class="token number">0</span>-3<span class="token punctuation">]</span> /dev/<span class="token variable">$&#123;device&#125;</span>

<span class="token builtin class-name">exit</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="中断补充"><a href="#中断补充" class="headerlink" title="中断补充"></a>中断补充</h2><p>关于中断嵌套，曾经是支持的（</p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240516234342751.png" alt="image-20240516234342751"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wr-web.github.io">RT</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wr-web.github.io/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/">https://wr-web.github.io/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wr-web.github.io" target="_blank">R0gerThat</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive50.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LDD3 学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive50.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-01</div><div class="title">LDD3 学习笔记</div></div></a></div><div><a href="/2024/04/23/LDD3-week1/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-23</div><div class="title">LDD3 学习笔记</div></div></a></div><div><a href="/2024/04/17/LLD3-week0/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive52.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-17</div><div class="title">LDD3 学习笔记</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">RT</div><div class="author-info__description">@Vidar-Team @CTFer @Game Lover </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/wr-web"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wr-web" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:orz1053131305@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://wr-web.github.io/atom.xml" target="_blank" title="Rss"><i class="fas fa-rss" style="color: #2d69d7;"></i></a><a class="social-icon" href="https://space.bilibili.com/13582048" target="_blank" title="BiliBili"><i class="fab fa-bilibili" style="color: #00a1d6;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">家人们加个友链</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LDD3-WEEK4"><span class="toc-number">1.</span> <span class="toc-text">LDD3 WEEK4</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85"><span class="toc-number">2.</span> <span class="toc-text">代码补充</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0"><span class="toc-number">2.1.</span> <span class="toc-text">第五章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#complete"><span class="toc-number">2.1.1.</span> <span class="toc-text">complete</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0"><span class="toc-number">2.2.</span> <span class="toc-text">第六章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-number">2.2.1.</span> <span class="toc-text">异步通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#llseek"><span class="toc-number">2.2.2.</span> <span class="toc-text">llseek</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">2.2.3.</span> <span class="toc-text">文件访问控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#scullsingle"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">scullsingle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sculluid"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">sculluid</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#scullpriv"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">scullpriv</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0"><span class="toc-number">2.3.</span> <span class="toc-text">第七章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4API"><span class="toc-number">2.3.1.</span> <span class="toc-text">时间API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#timer"><span class="toc-number">2.3.2.</span> <span class="toc-text">timer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tasklet"><span class="toc-number">2.3.3.</span> <span class="toc-text">tasklet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0"><span class="toc-number">2.4.</span> <span class="toc-text">第八章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#scullo-%E6%94%B9%E6%94%B9%E6%94%B9%EF%BC%9F%EF%BC%81"><span class="toc-number">2.4.1.</span> <span class="toc-text">scullo 改改改？！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main-c"><span class="toc-number">2.4.2.</span> <span class="toc-text">main.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmap-c"><span class="toc-number">2.4.3.</span> <span class="toc-text">mmap.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scullo-h"><span class="toc-number">2.4.4.</span> <span class="toc-text">scullo.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Makefile"><span class="toc-number">2.4.5.</span> <span class="toc-text">Makefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scullo-load-x2F-scullo-unload"><span class="toc-number">2.4.6.</span> <span class="toc-text">scullo_load&#x2F;scullo_unload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E8%A1%A5%E5%85%85"><span class="toc-number">2.5.</span> <span class="toc-text">中断补充</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-05-07T04:00:00.000Z" title="发表于 2024-05-07 12:00:00">2024-05-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive50.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-05-01T04:00:00.000Z" title="发表于 2024-05-01 12:00:00">2024-05-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/23/LDD3-week1/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/04/23/LDD3-week1/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-04-23T04:00:00.000Z" title="发表于 2024-04-23 12:00:00">2024-04-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/17/LLD3-week0/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive52.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/04/17/LLD3-week0/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-04-17T04:00:00.000Z" title="发表于 2024-04-17 12:00:00">2024-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/12/windows-terminal-customization/" title="Windows Terminal Customization"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive40.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows Terminal Customization"/></a><div class="content"><a class="title" href="/2024/01/12/windows-terminal-customization/" title="Windows Terminal Customization">Windows Terminal Customization</a><time datetime="2024-01-12T04:00:00.000Z" title="发表于 2024-01-12 12:00:00">2024-01-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By RT</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '017d73efa3d7d9bd35c1',
      clientSecret: '0b3746330e76c8310d622e4ae2d18a227afdfdd1',
      repo: 'blog_talk',
      owner: 'wr-web',
      admin: ['wr-web'],
      id: '555d29125df82f116a224d2179ea81d4',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>