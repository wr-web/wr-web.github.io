<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>LDD3 学习笔记 | R0gerThat</title><meta name="author" content="RT"><meta name="copyright" content="RT"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="调试&#x2F;并发&#x2F;高级字符驱动">
<meta property="og:type" content="article">
<meta property="og:title" content="LDD3 学习笔记">
<meta property="og:url" content="https://wr-web.github.io/2024/04/23/LDD3-week1/index.html">
<meta property="og:site_name" content="R0gerThat">
<meta property="og:description" content="调试&#x2F;并发&#x2F;高级字符驱动">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg">
<meta property="article:published_time" content="2024-04-23T04:00:00.000Z">
<meta property="article:modified_time" content="2024-06-24T04:53:29.471Z">
<meta property="article:author" content="RT">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wr-web/picture/archive02.jpg"><link rel="canonical" href="https://wr-web.github.io/2024/04/23/LDD3-week1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LDD3 学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-24 12:53:29'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="R0gerThat" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="R0gerThat"><span class="site-name">R0gerThat</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">LDD3 学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-23T04:00:00.000Z" title="发表于 2024-04-23 12:00:00">2024-04-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-24T04:53:29.471Z" title="更新于 2024-06-24 12:53:29">2024-06-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>63分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="LDD3 学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="LDD3-WEEK1"><a href="#LDD3-WEEK1" class="headerlink" title="LDD3 WEEK1"></a>LDD3 WEEK1</h1><p>关于几种 </p>
<p>一些 log level，感觉 ERR 还挺好用的</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">8</span>  #define KERN_EMERG	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* system is unusable */</span>
<span class="token number">9</span>  #define KERN_ALERT	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* action must be taken immediately */</span>
<span class="token number">10</span>  #define KERN_CRIT	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* critical conditions */</span>
<span class="token number">11</span>  #define KERN_ERR	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* error conditions */</span>
<span class="token number">12</span>  #define KERN_WARNING	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* warning conditions */</span>
<span class="token number">13</span>  #define KERN_NOTICE	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* normal but significant condition */</span>
<span class="token number">14</span>  #define KERN_INFO	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* informational */</span>
<span class="token number">15</span>  #define KERN_DEBUG	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* debug-level messages */</span>
<span class="token number">16</span>  
<span class="token number">17</span>  #define KERN_DEFAULT	KERN_SOH <span class="token string">""</span>	<span class="token comment">/* the default kernel loglevel */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="第三章续"><a href="#第三章续" class="headerlink" title="第三章续"></a>第三章续</h2><p>字符设备学习，LDD3 中的代码依然能跑，seq_file 的接口有一些改变</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">/</span>home<span class="token operator">/</span>rt<span class="token operator">/</span>kernel<span class="token operator">/</span>scull<span class="token operator">/</span>scull<span class="token punctuation">.</span>c<span class="token operator">:</span><span class="token number">142</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span> error<span class="token operator">:</span> passing argument <span class="token number">4</span> of ‘proc_create’ from incompatible pointer type <span class="token punctuation">[</span><span class="token operator">-</span>Werror<span class="token operator">=</span>incompatible<span class="token operator">-</span>pointer<span class="token operator">-</span>types<span class="token punctuation">]</span>
  <span class="token number">142</span> <span class="token operator">|</span>         <span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token string">"scullseq"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>scullseq_proc_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>                                          <span class="token operator">^</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span>
      <span class="token operator">|</span>                                          <span class="token operator">|</span>
      <span class="token operator">|</span>                                          <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接口有一些变化</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Create a set of file operations for our proc files.
 */</span>

<span class="token comment">// static struct file_operations scullseq_proc_ops = &#123;</span>
<span class="token comment">// 	.owner   = THIS_MODULE,</span>
<span class="token comment">// 	.open    = scullseq_proc_open,</span>
<span class="token comment">// 	.read    = seq_read,</span>
<span class="token comment">// 	.llseek  = seq_lseek,</span>
<span class="token comment">// 	.release = seq_release</span>
<span class="token comment">// &#125;;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">proc_ops</span> scullseq_proc_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>proc_open    <span class="token operator">=</span> scullseq_proc_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_read    <span class="token operator">=</span> seq_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_lseek   <span class="token operator">=</span> seq_lseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_release <span class="token operator">=</span> seq_release
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行结果，<strong>proc_ops 没有 owner 了，回头再看看</strong></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rt@rogerthat ~&#x2F;k&#x2F;scull&gt; sudo .&#x2F;scull.init start
Loading scull (loading file .&#x2F;scull.ko).
rt@rogerthat ~&#x2F;k&#x2F;scull&gt; ls &#x2F;dev&#x2F;scull*
&#x2F;dev&#x2F;scull0  &#x2F;dev&#x2F;scull2  &#x2F;dev&#x2F;scullpipe0  &#x2F;dev&#x2F;scullpipe2  &#x2F;dev&#x2F;scullpriv    &#x2F;dev&#x2F;sculluid
&#x2F;dev&#x2F;scull1  &#x2F;dev&#x2F;scull3  &#x2F;dev&#x2F;scullpipe1  &#x2F;dev&#x2F;scullpipe3  &#x2F;dev&#x2F;scullsingle  &#x2F;dev&#x2F;scullwuid
rt@rogerthat ~&#x2F;k&#x2F;scull&gt; ls &#x2F;proc&#x2F;scull*
&#x2F;proc&#x2F;scullseq
rt@rogerthat ~&#x2F;k&#x2F;scull&gt; sudo .&#x2F;scull.init stop
Unloading scull.
rt@rogerthat ~&#x2F;k&#x2F;scull&gt; ls &#x2F;dev&#x2F;scull*
fish: No matches for wildcard &#39;&#x2F;dev&#x2F;scull*&#39;. See &#96;help wildcards-globbing&#96;.
ls &#x2F;dev&#x2F;scull*
   ^
rt@rogerthat ~&#x2F;k&#x2F;scull [124]&gt; ls &#x2F;proc&#x2F;scull*
fish: No matches for wildcard &#39;&#x2F;proc&#x2F;scull*&#39;. See &#96;help wildcards-globbing&#96;.
ls &#x2F;proc&#x2F;scull*
   ^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Linux 2.6 的代码，基本还能用，有点震撼的。</p>
<p>简单测试</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">root@rogerthat:&#x2F;home&#x2F;rt&#x2F;kernel&#x2F;scull# .&#x2F;scull.init start
Loading scull (loading file .&#x2F;scull.ko).
root@rogerthat:&#x2F;home&#x2F;rt&#x2F;kernel&#x2F;scull# cat &#x2F;dev&#x2F;scull0
root@rogerthat:&#x2F;home&#x2F;rt&#x2F;kernel&#x2F;scull# echo 2333333 &gt; &#x2F;dev&#x2F;scull0
root@rogerthat:&#x2F;home&#x2F;rt&#x2F;kernel&#x2F;scull# dmesg
[25218.564517] scull: f_pos: 24, size: 24
root@rogerthat:&#x2F;home&#x2F;rt&#x2F;kernel&#x2F;scull# cat &#x2F;dev&#x2F;scull0 
2333333
root@rogerthat:&#x2F;home&#x2F;rt&#x2F;kernel&#x2F;scull# dmesg 
[25218.564517] scull: f_pos: 24, size: 24
[25336.390189] scull: f_pos: 0, size: 0
[25461.386015] scull: f_pos: 0, size: 8
[25461.386018] scull: qset: 1000, quantum: 4000, itemsize: 4000000
[25461.386020] scull: item: 0, s_pos: 0, q_pos: 0
root@rogerthat:&#x2F;home&#x2F;rt&#x2F;kernel&#x2F;scull# .&#x2F;scull.init stop
Unloading scull.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>会发现 <code>scull_read</code> 会在其他时候被调用，暂时不清楚原因，回头再看看。</strong></p>
<p>像注册这类的函数形而上学的了解了一下，根据一些文章学习一下比较新的内核下的字符设备驱动，比如鼠标驱动 <code>drivers/input/mouse/logibm.c</code>，打印机驱动 <code>drivers/char/lp.c</code> 。Linux VERSION &#x3D; 6</p>
<p><img src="https://static001.geekbang.org/resource/image/2e/e6/2e29767e84b299324ea7fc524a3dcee6.jpeg"></p>
<p>补充 <code>struct cdev</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>                  <span class="token comment">//内嵌的内核对象.</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>                 <span class="token comment">//该字符设备所在的内核模块的对象指针.</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>    <span class="token comment">//该结构描述了字符设备所能实现的方法，是极为关键的一个结构体.</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>                <span class="token comment">//用来将已经向内核注册的所有字符设备形成链表.</span>
    <span class="token class-name">dev_t</span> dev<span class="token punctuation">;</span>                            <span class="token comment">//字符设备的设备号，由主设备号和次设备号构成.</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>                   <span class="token comment">//隶属于同一主设备号的次设备号的个数.</span>
<span class="token punctuation">&#125;</span> __randomize_layout<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="第四章，关于调试"><a href="#第四章，关于调试" class="headerlink" title="第四章，关于调试"></a>第四章，关于调试</h2><p>ioctl TIOCLINUX</p>
<p>某种粗暴的方式，输出 printk 日志。</p>
<pre class="line-numbers language-none"><code class="language-none">rt@rogerthat ~&#x2F;k&#x2F;scull [1]&gt; sudo cat &#x2F;proc&#x2F;kmsg
[sudo] password for rt: 
&lt;7&gt;[25461.386029] scull: f_pos: 8, size: 8
&lt;7&gt;[27016.453437] scull: f_pos: 0, size: 4
&lt;7&gt;[27016.453440] scull: qset: 1000, quantum: 4000, itemsize: 4000000
&lt;7&gt;[27016.453441] scull: item: 0, s_pos: 0, q_pos: 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>printk</code> 最终会调用到 <code>/linux/kernel/printk/printk.c vprintk-emit</code> c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">2361</span>  <span class="token keyword">int</span> <span class="token function">vprintk_default</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> va_list args<span class="token punctuation">)</span>
<span class="token number">2362</span>  <span class="token punctuation">&#123;</span>
<span class="token number">2363</span>  	<span class="token keyword">return</span> <span class="token function">vprintk_emit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> LOGLEVEL_DEFAULT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2364</span>  <span class="token punctuation">&#125;</span>
<span class="token number">2365</span>  <span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>vprintk_default<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>稍微翻了一下源码，没找到环形缓存的代码，回头再看看</strong></p>
<p>尝试了一下 <code>strace</code> 发现系统调用与以前相比，不再使用 <code>open</code>，而是 <code>openat(AT_FDCWD, &quot;/dev/scull0&quot;, O_RDONLY) = 3</code> ，从这个来看也没什么太大的变化。</p>
<p>试了一下 oops</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">scull_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">[96688.577651] BUG: kernel NULL pointer dereference, address: 0000000000000000
[96688.577892] #PF: supervisor write access in kernel mode
[96688.577975] #PF: error_code(0x0002) - not-present page
[96688.578065] PGD 0 P4D 0 
[96688.578130] Oops: 0002 [#1] PREEMPT SMP NOPTI
[96688.578242] CPU: 8 PID: 14514 Comm: bash Tainted: G           OE     5.19.0-46-generic #47-Ubuntu
[96688.578354] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04&#x2F;01&#x2F;2014
[96688.578441] RIP: 0010:scull_write+0x9&#x2F;0x1f [scull]
[96688.578522] Code: 44 00 00 55 48 89 e5 5d c3 cc cc cc cc 0f 1f 44 00 00 55 48 89 e5 b8 00 00 00 00 5d c3 cc cc cc cc 0f 1f 44 00 00 55 48 89 e5 &lt;c7&gt; 04 25 00 00 00 00 00 00 00 00 b8 00 00 00 00 5d c3 cc cc cc cc
[96688.578679] RSP: 0018:ffffa543440d7e58 EFLAGS: 00010286
[96688.578770] RAX: ffffffffc0b870a0 RBX: 0000000000000000 RCX: ffffa543440d7ea0
[96688.578856] RDX: 0000000000000004 RSI: 0000563f3a7f4f90 RDI: ffff928fc632f800
[96688.578919] RBP: ffffa543440d7e58 R08: 0000000000000000 R09: 0000000000000000
[96688.578980] R10: 0000000000000000 R11: 0000000000000000 R12: ffff928fc632f800
[96688.579045] R13: 0000000000000004 R14: ffffa543440d7ea0 R15: 0000563f3a7f4f90
[96688.579104] FS:  00007fa5a522c740(0000) GS:ffff9296dfc00000(0000) knlGS:0000000000000000
[96688.579162] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[96688.579219] CR2: 0000000000000000 CR3: 00000001610fe000 CR4: 0000000000750ee0
[96688.579288] PKRU: 55555554
[96688.579344] Call Trace:
[96688.579396]  &lt;TASK&gt;
[96688.579443]  vfs_write+0xba&#x2F;0x290
[96688.579517]  ksys_write+0x73&#x2F;0x100
[96688.579571]  __x64_sys_write+0x19&#x2F;0x30
[96688.579623]  do_syscall_64+0x5b&#x2F;0x90
[96688.579685]  ? do_syscall_64+0x67&#x2F;0x90
[96688.579738]  ? syscall_exit_to_user_mode+0x29&#x2F;0x50
[96688.579793]  ? do_syscall_64+0x67&#x2F;0x90
[96688.579847]  entry_SYSCALL_64_after_hwframe+0x63&#x2F;0xcd
[96688.579901] RIP: 0033:0x7fa5a510cd94
[96688.579956] Code: 15 71 90 0e 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b7 0f 1f 00 f3 0f 1e fa 80 3d 4d 18 0f 00 00 74 13 b8 01 00 00 00 0f 05 &lt;48&gt; 3d 00 f0 ff ff 77 54 c3 0f 1f 00 48 83 ec 28 48 89 54 24 18 48
[96688.580069] RSP: 002b:00007ffd278688d8 EFLAGS: 00000202 ORIG_RAX: 0000000000000001
[96688.580126] RAX: ffffffffffffffda RBX: 0000000000000004 RCX: 00007fa5a510cd94
[96688.580185] RDX: 0000000000000004 RSI: 0000563f3a7f4f90 RDI: 0000000000000001
[96688.580240] RBP: 0000563f3a7f4f90 R08: 0000563f399f2a20 R09: 0000000000000073
[96688.580295] R10: 00000000ffffffff R11: 0000000000000202 R12: 0000000000000004
[96688.580361] R13: 00007fa5a51f7760 R14: 00007fa5a51f35e0 R15: 00007fa5a51f29e0
[96688.580446]  &lt;&#x2F;TASK&gt;
[96688.580516] Modules linked in: scull(OE) tls xt_CHECKSUM ipt_REJECT nf_reject_ipv4 xt_conntrack xt_tcpudp xt_MASQUERADE nf_conntrack_netlink nft_chain_nat xfrm_user xfrm_algo nf_nat nf_conntrack xt_addrtype nf_defrag_ipv6 nft_compat nf_defrag_ipv4 br_netfilter nf_tables nfnetlink bridge stp llc intel_rapl_msr intel_rapl_common overlay cfg80211 kvm_amd ccp binfmt_misc input_leds joydev kvm serio_raw mac_hid vmgenid dm_multipath scsi_dh_rdac scsi_dh_emc scsi_dh_alua ramoops msr pstore_blk reed_solomon pstore_zone efi_pstore qemu_fw_cfg ip_tables x_tables autofs4 btrfs blake2b_generic raid10 raid456 async_raid6_recov async_memcpy async_pq async_xor async_tx xor raid6_pq libcrc32c raid1 raid0 multipath linear bochs drm_vram_helper drm_ttm_helper ttm crct10dif_pclmul drm_kms_helper syscopyarea crc32_pclmul hid_generic ghash_clmulni_intel sysfillrect sysimgblt aesni_intel usbhid virtio_net fb_sys_fops net_failover crypto_simd hid cryptd psmouse failover virtio_scsi pata_acpi drm i2c_piix4
[96688.580566]  floppy [last unloaded: scull]
[96688.581822] CR2: 0000000000000000
[96688.582052] ---[ end trace 0000000000000000 ]---
[96688.582279] RIP: 0010:scull_write+0x9&#x2F;0x1f [scull]
[96688.582504] Code: 44 00 00 55 48 89 e5 5d c3 cc cc cc cc 0f 1f 44 00 00 55 48 89 e5 b8 00 00 00 00 5d c3 cc cc cc cc 0f 1f 44 00 00 55 48 89 e5 &lt;c7&gt; 04 25 00 00 00 00 00 00 00 00 b8 00 00 00 00 5d c3 cc cc cc cc
[96688.582980] RSP: 0018:ffffa543440d7e58 EFLAGS: 00010286
[96688.583219] RAX: ffffffffc0b870a0 RBX: 0000000000000000 RCX: ffffa543440d7ea0
[96688.583458] RDX: 0000000000000004 RSI: 0000563f3a7f4f90 RDI: ffff928fc632f800
[96688.583695] RBP: ffffa543440d7e58 R08: 0000000000000000 R09: 0000000000000000
[96688.583929] R10: 0000000000000000 R11: 0000000000000000 R12: ffff928fc632f800
[96688.584163] R13: 0000000000000004 R14: ffffa543440d7ea0 R15: 0000563f3a7f4f90
[96688.584385] FS:  00007fa5a522c740(0000) GS:ffff9296dfc00000(0000) knlGS:0000000000000000
[96688.584609] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[96688.584829] CR2: 0000000000000000 CR3: 00000001610fe000 CR4: 0000000000750ee0
[96688.585051] PKRU: 55555554<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>比较直白</p>
<h2 id="第五章，并发，竞争"><a href="#第五章，并发，竞争" class="headerlink" title="第五章，并发，竞争"></a>第五章，并发，竞争</h2><p>P，</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">down_trylock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>V，</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>竞争很容易出 <strong>bug</strong>，比如在写锁的时候是否有考虑中断，这有可能导致死锁</p>
<p>三四五章的代码</p>
<p>scull.h</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
 <span class="token operator">*</span> scull<span class="token punctuation">.</span>h <span class="token operator">--</span> definitions <span class="token keyword">for</span> the <span class="token keyword">char</span> module
 <span class="token operator">*</span>
 <span class="token operator">*</span> <span class="token function">Copyright</span> <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2001</span> Alessandro Rubini and Jonathan Corbet
 <span class="token operator">*</span> <span class="token function">Copyright</span> <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2001</span> O'Reilly <span class="token operator">&amp;</span> Associates
 <span class="token operator">*</span>
 <span class="token operator">*</span> The source code in this file can be freely used<span class="token punctuation">,</span> adapted<span class="token punctuation">,</span>
 <span class="token operator">*</span> and redistributed in source or binary form<span class="token punctuation">,</span> so <span class="token keyword">long</span> as an
 <span class="token operator">*</span> acknowledgment appears in derived source files<span class="token punctuation">.</span>  The citation
 <span class="token operator">*</span> should list that the code comes from the book "Linux Device
 <span class="token operator">*</span> Drivers" by Alessandro Rubini and Jonathan Corbet<span class="token punctuation">,</span> published
 <span class="token operator">*</span> by O'Reilly <span class="token operator">&amp;</span> Associates<span class="token punctuation">.</span>   No warranty is attached<span class="token punctuation">;</span>
 <span class="token operator">*</span> we cannot take responsibility <span class="token keyword">for</span> errors or fitness <span class="token keyword">for</span> use<span class="token punctuation">.</span>
 <span class="token operator">*</span>
 <span class="token operator">*</span> $Id<span class="token operator">:</span> scull<span class="token punctuation">.</span>h<span class="token punctuation">,</span>v <span class="token number">1.15</span> <span class="token number">2004</span><span class="token operator">/</span><span class="token number">11</span><span class="token operator">/</span><span class="token number">04</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">18</span> rubini Exp $
 <span class="token operator">*</span><span class="token operator">/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_SCULL_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_SCULL_H_</span></span>

<span class="token comment">/*
 * Macros to help debugging
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">PDEBUG             </span><span class="token comment">/* undef it, just in case */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">ifdef</span> <span class="token expression">__KERNEL__</span></span>
     <span class="token comment">/* This one if debugging is on, and kernel space */</span>
<span class="token macro property"><span class="token directive-hash">#</span>    <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">printk</span><span class="token punctuation">(</span> KERN_DEBUG </span><span class="token string">"scull: "</span> <span class="token expression">fmt<span class="token punctuation">,</span> </span><span class="token punctuation">##</span> <span class="token expression">args<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">else</span></span>
     <span class="token comment">/* This one for user space */</span>
<span class="token macro property"><span class="token directive-hash">#</span>    <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> </span><span class="token punctuation">##</span> <span class="token expression">args<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token comment">/* not debugging: nothing */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">PDEBUGG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUGG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token comment">/* nothing: it's a placeholder */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_MAJOR</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_MAJOR</span> <span class="token expression"><span class="token number">0</span>   </span><span class="token comment">/* dynamic major by default */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_NR_DEVS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_NR_DEVS</span> <span class="token expression"><span class="token number">4</span>    </span><span class="token comment">/* scull0 through scull3 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_P_NR_DEVS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_P_NR_DEVS</span> <span class="token expression"><span class="token number">4</span>  </span><span class="token comment">/* scullpipe0 through scullpipe3 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * The bare device is a variable-length region of memory.
 * Use a linked list of indirect blocks.
 *
 * "scull_dev->data" points to an array of pointers, each
 * pointer refers to a memory area of SCULL_QUANTUM bytes.
 *
 * The array (quantum-set) is SCULL_QSET long.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_QUANTUM</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_QUANTUM</span> <span class="token expression"><span class="token number">4000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_QSET</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_QSET</span>    <span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * The pipe device is a simple circular buffer. Here its default size
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_P_BUFFER</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_P_BUFFER</span> <span class="token expression"><span class="token number">4000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * Representation of scull quantum sets.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>  <span class="token comment">/* Pointer to first quantum set */</span>
	<span class="token keyword">int</span> quantum<span class="token punctuation">;</span>              <span class="token comment">/* the current quantum size */</span>
	<span class="token keyword">int</span> qset<span class="token punctuation">;</span>                 <span class="token comment">/* the current array size */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>       <span class="token comment">/* amount of data stored here */</span>
	<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>     <span class="token comment">/* mutual exclusion semaphore     */</span>
	<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>	  <span class="token comment">/* Char device structure		*/</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * The different configurable parameters
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_major<span class="token punctuation">;</span>     <span class="token comment">/* main.c */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_nr_devs<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_quantum<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_qset<span class="token punctuation">;</span>

<span class="token comment">/*
 * Prototypes for shared functions
 */</span>
<span class="token keyword">int</span> <span class="token function">scull_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">scull_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">scull_trim</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">scull_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">scull_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">loff_t</span>  <span class="token function">scull_llseek</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* _SCULL_H_ */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="scull-c"><a href="#scull-c" class="headerlink" title="scull.c"></a>scull.c</h3><p>包含有 &#x2F;proc 的处理（使用了 seq_open 等内核函数），down_interruptible、up 同步机制。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * scull.c -- the bare scull char module
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 *
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/moduleparam.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/seq_file.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scull.h"</span></span>

<span class="token comment">/*
 * Our parameters which can be set at load time.
 */</span>

<span class="token keyword">int</span> scull_major <span class="token operator">=</span>   SCULL_MAJOR<span class="token punctuation">;</span>
<span class="token keyword">int</span> scull_minor <span class="token operator">=</span>   <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> scull_nr_devs <span class="token operator">=</span> SCULL_NR_DEVS<span class="token punctuation">;</span>	<span class="token comment">/* number of bare scull devices */</span>
<span class="token keyword">int</span> scull_quantum <span class="token operator">=</span> SCULL_QUANTUM<span class="token punctuation">;</span>
<span class="token keyword">int</span> scull_qset <span class="token operator">=</span>    SCULL_QSET<span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_minor<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_nr_devs<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_quantum<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_qset<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"Alessandro Rubini, Jonathan Corbet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>scull_devices<span class="token punctuation">;</span>	<span class="token comment">/* allocated in scull_init_module */</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG </span><span class="token comment">/* use proc only if debugging */</span></span>
<span class="token comment">/*
 * The proc filesystem: function to read and entry
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">scull_seq_start</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pos <span class="token operator">>=</span> scull_nr_devs<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>   <span class="token comment">/* No more to read */</span>

	<span class="token keyword">return</span> scull_devices <span class="token operator">+</span> <span class="token operator">*</span>pos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">scull_seq_next</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>pos<span class="token punctuation">)</span> <span class="token operator">>=</span> scull_nr_devs<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> scull_devices <span class="token operator">+</span> <span class="token operator">*</span>pos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_seq_stop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">/* Actually, there's nothing to do here */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_seq_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span><span class="token punctuation">)</span> v<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>d<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>

	<span class="token function">seq_printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"\nDevice %i: qset %i, q %i, sz %li\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dev <span class="token operator">-</span> scull_devices<span class="token punctuation">)</span><span class="token punctuation">,</span>
			dev<span class="token operator">-></span>qset<span class="token punctuation">,</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">,</span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>d <span class="token operator">=</span> dev<span class="token operator">-></span>data<span class="token punctuation">;</span> d<span class="token punctuation">;</span> d <span class="token operator">=</span> d<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* scan the list */</span>
		<span class="token function">seq_printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"  item at %p, qset at %p\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> d<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>d<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* dump only the last item */</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
					<span class="token function">seq_printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"    % 4i: %8p\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> d<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Tie the sequence operators up.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">seq_operations</span> scull_seq_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>start <span class="token operator">=</span> scull_seq_start<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>next  <span class="token operator">=</span> scull_seq_next<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>stop  <span class="token operator">=</span> scull_seq_stop<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>show  <span class="token operator">=</span> scull_seq_show
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Now to implement the /proc files we need only make an open
 * method which sets up the sequence operators.
 */</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scullseq_proc_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">seq_open</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_seq_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Create a set of file operations for our proc files.
 */</span>

<span class="token comment">// static struct file_operations scullseq_proc_ops = &#123;</span>
<span class="token comment">// 	.owner   = THIS_MODULE,</span>
<span class="token comment">// 	.open    = scullseq_proc_open,</span>
<span class="token comment">// 	.read    = seq_read,</span>
<span class="token comment">// 	.llseek  = seq_lseek,</span>
<span class="token comment">// 	.release = seq_release</span>
<span class="token comment">// &#125;;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">proc_ops</span> scullseq_proc_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>proc_open    <span class="token operator">=</span> scullseq_proc_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_read    <span class="token operator">=</span> seq_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_lseek   <span class="token operator">=</span> seq_lseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_release <span class="token operator">=</span> seq_release
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Actually create (and remove) the /proc file(s).
 */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_create_proc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token string">"scullseq"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>scullseq_proc_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_remove_proc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">/* no problem if it was not registered */</span>
	<span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"scullseq"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* SCULL_DEBUG */</span></span>

<span class="token comment">/*
 * Empty out the scull device; must be called with the device
 * semaphore held.
 */</span>
<span class="token keyword">int</span> <span class="token function">scull_trim</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>   <span class="token comment">/* "dev" is not-null */</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>dptr <span class="token operator">=</span> dev<span class="token operator">-></span>data<span class="token punctuation">;</span> dptr<span class="token punctuation">;</span> dptr <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* all the list items */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> qset<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
				<span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			dptr<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		next <span class="token operator">=</span> dptr<span class="token operator">-></span>next<span class="token punctuation">;</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	dev<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	dev<span class="token operator">-></span>quantum <span class="token operator">=</span> scull_quantum<span class="token punctuation">;</span>
	dev<span class="token operator">-></span>qset <span class="token operator">=</span> scull_qset<span class="token punctuation">;</span>
	dev<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Open and close
 */</span>
<span class="token keyword">int</span> <span class="token function">scull_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

	dev <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_cdev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span><span class="token punctuation">,</span> cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span> <span class="token comment">/* for other methods */</span>

	<span class="token comment">/* now trim to 0 the length of the device if open was write-only */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>

		<span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* ignore errors */</span>
		<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">scull_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*
 * Follow the list
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span><span class="token function">scull_follow</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>qs <span class="token operator">=</span> dev<span class="token operator">-></span>data<span class="token punctuation">;</span>

		<span class="token comment">/* Allocate first qset explicitly if need be */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> qs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		qs <span class="token operator">=</span> dev<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>qs <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">/* Never mind */</span>

		<span class="token function">memset</span><span class="token punctuation">(</span>qs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/* Then follow the list */</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>qs<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			qs<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token operator">-></span>next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">/* Never mind */</span>

			<span class="token function">memset</span><span class="token punctuation">(</span>qs<span class="token operator">-></span>next<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		qs <span class="token operator">=</span> qs<span class="token operator">-></span>next<span class="token punctuation">;</span>
		<span class="token keyword">continue</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> qs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Data management: read and write
 */</span>

<span class="token class-name">ssize_t</span> <span class="token function">scull_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>	<span class="token comment">/* the first listitem */</span>
	<span class="token keyword">int</span> quantum <span class="token operator">=</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">,</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>
	<span class="token keyword">int</span> itemsize <span class="token operator">=</span> quantum <span class="token operator">*</span> qset<span class="token punctuation">;</span> <span class="token comment">/* how many bytes in the listitem */</span>
	<span class="token keyword">int</span> item<span class="token punctuation">,</span> s_pos<span class="token punctuation">,</span> q_pos<span class="token punctuation">,</span> rest<span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"f_pos: %lld, size: %lu"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">*</span>f_pos<span class="token punctuation">,</span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>f_pos <span class="token operator">>=</span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>f_pos <span class="token operator">+</span> count <span class="token operator">></span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span>
		count <span class="token operator">=</span> dev<span class="token operator">-></span>size <span class="token operator">-</span> <span class="token operator">*</span>f_pos<span class="token punctuation">;</span>

	<span class="token comment">/* find listitem, qset index, and offset in the quantum */</span>
	item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">/</span> itemsize<span class="token punctuation">;</span>
	rest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">%</span> itemsize<span class="token punctuation">;</span>
	s_pos <span class="token operator">=</span> rest <span class="token operator">/</span> quantum<span class="token punctuation">;</span> q_pos <span class="token operator">=</span> rest <span class="token operator">%</span> quantum<span class="token punctuation">;</span>
	<span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"qset: %d, quantum: %d, itemsize: %d"</span><span class="token punctuation">,</span> qset<span class="token punctuation">,</span> quantum<span class="token punctuation">,</span> itemsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"item: %d, s_pos: %d, q_pos: %d"</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> s_pos<span class="token punctuation">,</span> q_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* follow the list up to the right position (defined elsewhere) */</span>
	dptr <span class="token operator">=</span> <span class="token function">scull_follow</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>dptr <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token operator">!</span>dptr<span class="token operator">-></span>data <span class="token operator">||</span> <span class="token operator">!</span> dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span> <span class="token comment">/* don't fill holes */</span>

	<span class="token comment">/* read only up to the end of this quantum */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">)</span>
		count <span class="token operator">=</span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">+</span> q_pos<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		retval <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">*</span>f_pos <span class="token operator">+=</span> count<span class="token punctuation">;</span>
	retval <span class="token operator">=</span> count<span class="token punctuation">;</span>

  out<span class="token operator">:</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ssize_t scull_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos)</span>
<span class="token comment">// &#123;</span>
<span class="token comment">// 	*(int *)0 = 0;</span>
<span class="token comment">// 	return 0;</span>
<span class="token comment">// &#125;</span>

<span class="token class-name">ssize_t</span> <span class="token function">scull_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> quantum <span class="token operator">=</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">,</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>
	<span class="token keyword">int</span> itemsize <span class="token operator">=</span> quantum <span class="token operator">*</span> qset<span class="token punctuation">;</span>
	<span class="token keyword">int</span> item<span class="token punctuation">,</span> s_pos<span class="token punctuation">,</span> q_pos<span class="token punctuation">,</span> rest<span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span> <span class="token comment">/* value used in "goto out" statements */</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>

	<span class="token comment">/* find listitem, qset index and offset in the quantum */</span>
	item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">/</span> itemsize<span class="token punctuation">;</span>
	rest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">%</span> itemsize<span class="token punctuation">;</span>
	s_pos <span class="token operator">=</span> rest <span class="token operator">/</span> quantum<span class="token punctuation">;</span> q_pos <span class="token operator">=</span> rest <span class="token operator">%</span> quantum<span class="token punctuation">;</span>

	<span class="token comment">/* follow the list up to the right position */</span>
	dptr <span class="token operator">=</span> <span class="token function">scull_follow</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		dptr<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>qset <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>

		<span class="token function">memset</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> qset <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>quantum<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">/* write only up to the end of this quantum */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">)</span>
		count <span class="token operator">=</span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token operator">+</span>q_pos<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		retval <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">*</span>f_pos <span class="token operator">+=</span> count<span class="token punctuation">;</span>
	retval <span class="token operator">=</span> count<span class="token punctuation">;</span>

		<span class="token comment">/* update the size */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>size <span class="token operator">&lt;</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
		dev<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token operator">*</span>f_pos<span class="token punctuation">;</span>

  out<span class="token operator">:</span>
	<span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The "extended" operations -- only seek
 */</span>

<span class="token class-name">loff_t</span> <span class="token function">scull_llseek</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token class-name">loff_t</span> newpos<span class="token punctuation">;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>whence<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	  <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">/* SEEK_SET */</span>
		newpos <span class="token operator">=</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	  <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">/* SEEK_CUR */</span>
		newpos <span class="token operator">=</span> filp<span class="token operator">-></span>f_pos <span class="token operator">+</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	  <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token comment">/* SEEK_END */</span>
		newpos <span class="token operator">=</span> dev<span class="token operator">-></span>size <span class="token operator">+</span> off<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">/* can't happen */</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>newpos <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	filp<span class="token operator">-></span>f_pos <span class="token operator">=</span> newpos<span class="token punctuation">;</span>
	<span class="token keyword">return</span> newpos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span>    THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>llseek <span class="token operator">=</span>   scull_llseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span>     scull_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span>    scull_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span>     scull_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span>  scull_release<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Finally, the module stuff
 */</span>

<span class="token comment">/*
 * The cleanup function is used to handle initialization failures as well.
 * Thefore, it must be careful to work correctly even if some of the items
 * have not been initialized
 */</span>
<span class="token keyword">void</span> <span class="token function">scull_cleanup_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> scull_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Get rid of our char dev entries */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scull_devices<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_nr_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">scull_trim</span><span class="token punctuation">(</span>scull_devices <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>scull_devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG </span><span class="token comment">/* use proc only if debugging */</span></span>
	<span class="token function">scull_remove_proc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token comment">/* cleanup_module is never called if registering failed */</span>
	<span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> scull_nr_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Set up the char_dev structure for this device.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_setup_cdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">,</span> devno<span class="token punctuation">;</span>

	devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> scull_minor <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Fail gracefully if need be */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"Error %d adding scull%d"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> <span class="token function">scull_init_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
	<span class="token class-name">dev_t</span> dev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Get a range of minor numbers to work with, asking for a dynamic
 * major unless directed otherwise at load time.
 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>scull_major<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		dev <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> scull_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> scull_nr_devs<span class="token punctuation">,</span> <span class="token string">"scull"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		result <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token punctuation">,</span> scull_minor<span class="token punctuation">,</span> scull_nr_devs<span class="token punctuation">,</span> <span class="token string">"scull"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		scull_major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"scull: can't get major %d\n"</span><span class="token punctuation">,</span> scull_major<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

		<span class="token comment">/*
	 * allocate the devices -- we can't have them static, as the number
	 * can be specified at load time
	 */</span>
	scull_devices <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>scull_nr_devs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scull_devices<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		result <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> fail<span class="token punctuation">;</span>  <span class="token comment">/* Make this more graceful */</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>scull_devices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scull_nr_devs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* Initialize each device. */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_nr_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>quantum <span class="token operator">=</span> scull_quantum<span class="token punctuation">;</span>
		scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>qset <span class="token operator">=</span> scull_qset<span class="token punctuation">;</span>
		<span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">scull_setup_cdev</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG </span><span class="token comment">/* only when debugging */</span></span>
	<span class="token function">scull_create_proc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* succeed */</span>

  fail<span class="token operator">:</span>
	<span class="token function">scull_cleanup_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>scull_init_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>scull_cleanup_module<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="第六章-高级字符驱动"><a href="#第六章-高级字符驱动" class="headerlink" title="第六章 高级字符驱动"></a>第六章 高级字符驱动</h2><p>ioctl 内核的定义与书中的略有差别，第一个参数一般是设备，比如 usb 串口的 ioctl 第一个参数是 struct tty_struct *tty，net 的第一个参数是 struct socket *socket</p>
<p>ioctl 命令代码，高八位关联设备 magic number，低八位是一个顺序号（设备内唯一）</p>
<p>考察 <code>/linux/include/uapi/asm-generic/ioctl.h</code></p>
<p>现在的 ioctl-number 文档似乎在 <code>/linux/Documentation/userspace-api/ioctl/ioctl-number.rst</code></p>
<p>对于 put_user(datum, ptr) 和 get_user(datum, ptr)，我总觉得有点不好理解，实际上这个命名还是有点歧义的，感觉很有可能会有人用错。真正的命名应该是 put_to_user 和 get_from_user。如果有人理解为 put_from_user 那就完了。</p>
<p>一些 task 状态，<code>/linux/include/linux/sched.h</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">95</span>  #define TASK_RUNNING			<span class="token number">0x00000000</span>
<span class="token number">96</span>  #define TASK_INTERRUPTIBLE		<span class="token number">0x00000001</span>
<span class="token number">97</span>  #define TASK_UNINTERRUPTIBLE		<span class="token number">0x00000002</span>
<span class="token number">98</span>  #define __TASK_STOPPED			<span class="token number">0x00000004</span>
<span class="token number">99</span>  #define __TASK_TRACED			<span class="token number">0x00000008</span>
<span class="token number">100</span>  <span class="token comment">/* Used in tsk->exit_state: */</span>
<span class="token number">101</span>  #define EXIT_DEAD			<span class="token number">0x00000010</span>
<span class="token number">102</span>  #define EXIT_ZOMBIE			<span class="token number">0x00000020</span>
<span class="token number">103</span>  #define <span class="token function">EXIT_TRACE</span>			<span class="token punctuation">(</span>EXIT_ZOMBIE <span class="token operator">|</span> EXIT_DEAD<span class="token punctuation">)</span>
<span class="token number">104</span>  <span class="token comment">/* Used in tsk->__state again: */</span>
<span class="token number">105</span>  #define TASK_PARKED			<span class="token number">0x00000040</span>
<span class="token number">106</span>  #define TASK_DEAD			<span class="token number">0x00000080</span>
<span class="token number">107</span>  #define TASK_WAKEKILL			<span class="token number">0x00000100</span>
<span class="token number">108</span>  #define TASK_WAKING			<span class="token number">0x00000200</span>
<span class="token number">109</span>  #define TASK_NOLOAD			<span class="token number">0x00000400</span>
<span class="token number">110</span>  #define TASK_NEW			<span class="token number">0x00000800</span>
<span class="token number">111</span>  #define TASK_RTLOCK_WAIT		<span class="token number">0x00001000</span>
<span class="token number">112</span>  #define TASK_FREEZABLE			<span class="token number">0x00002000</span>
<span class="token number">113</span>  #define <span class="token function">__TASK_FREEZABLE_UNSAFE</span>	       <span class="token punctuation">(</span><span class="token number">0x00004000</span> <span class="token operator">*</span> <span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_LOCKDEP<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">114</span>  #define TASK_FROZEN			<span class="token number">0x00008000</span>
<span class="token number">115</span>  #define TASK_STATE_MAX			<span class="token number">0x00010000</span>
<span class="token number">116</span>  
<span class="token number">117</span>  #define <span class="token function">TASK_ANY</span>			<span class="token punctuation">(</span>TASK_STATE_MAX<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">118</span>  
<span class="token number">119</span>  <span class="token comment">/*
120   * DO NOT ADD ANY NEW USERS !
121   */</span>
<span class="token number">122</span>  #define <span class="token function">TASK_FREEZABLE_UNSAFE</span>		<span class="token punctuation">(</span>TASK_FREEZABLE <span class="token operator">|</span> __TASK_FREEZABLE_UNSAFE<span class="token punctuation">)</span>
<span class="token number">123</span>  
<span class="token number">124</span>  <span class="token comment">/* Convenience macros for the sake of set_current_state: */</span>
<span class="token number">125</span>  #define <span class="token function">TASK_KILLABLE</span>			<span class="token punctuation">(</span>TASK_WAKEKILL <span class="token operator">|</span> TASK_UNINTERRUPTIBLE<span class="token punctuation">)</span>
<span class="token number">126</span>  #define <span class="token function">TASK_STOPPED</span>			<span class="token punctuation">(</span>TASK_WAKEKILL <span class="token operator">|</span> __TASK_STOPPED<span class="token punctuation">)</span>
<span class="token number">127</span>  #define TASK_TRACED			__TASK_TRACED
<span class="token number">128</span>  
<span class="token number">129</span>  #define <span class="token function">TASK_IDLE</span>			<span class="token punctuation">(</span>TASK_UNINTERRUPTIBLE <span class="token operator">|</span> TASK_NOLOAD<span class="token punctuation">)</span>
<span class="token number">130</span>  
<span class="token number">131</span>  <span class="token comment">/* Convenience macros for the sake of wake_up(): */</span>
<span class="token number">132</span>  #define <span class="token function">TASK_NORMAL</span>			<span class="token punctuation">(</span>TASK_INTERRUPTIBLE <span class="token operator">|</span> TASK_UNINTERRUPTIBLE<span class="token punctuation">)</span>
<span class="token number">133</span>  
<span class="token number">134</span>  <span class="token comment">/* get_task_state(): */</span>
<span class="token number">135</span>  #define <span class="token function">TASK_REPORT</span>			<span class="token punctuation">(</span>TASK_RUNNING <span class="token operator">|</span> TASK_INTERRUPTIBLE <span class="token operator">|</span> \
<span class="token number">136</span>  					 TASK_UNINTERRUPTIBLE <span class="token operator">|</span> __TASK_STOPPED <span class="token operator">|</span> \
<span class="token number">137</span>  					 __TASK_TRACED <span class="token operator">|</span> EXIT_DEAD <span class="token operator">|</span> EXIT_ZOMBIE <span class="token operator">|</span> \
<span class="token number">138</span>  					 TASK_PARKED<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现看电子 pdf 效率太慢，去打印了点，笔记也在纸质上，到时候摘一点回来。</p>
<h3 id="ioctl-x2F-pipe-defination"><a href="#ioctl-x2F-pipe-defination" class="headerlink" title="ioctl&#x2F;pipe defination"></a>ioctl&#x2F;pipe defination</h3><p>存在一些兼容性问题</p>
<p>access_ok 第一个参数被移除</p>
<pre class="line-numbers language-none"><code class="language-none">Kernel 5.0 removed VERIFY_READ and VERIFY_WRITE and removed the first
 * parameter of access_ok() which was set to VERIFY_READ or VERIFY_WRITE.
 * That has been redundant since kernel 2.5.70, and even then it was only
 * checked for kernels that support old 386 processors.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>semaphore 接口改变</p>
<pre class="line-numbers language-none"><code class="language-none">init_MUTEX&#123;_LOCKED&#125;() was initially implemented as a semaphore. Semaphores were only in older 2.6.16 kernels, now mutex replace with earlier semaphores implementation, check the below api&#39;s and linux&#x2F;mutex.h header<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>SPIN_LOCK_UNLOCKED 定义的接口改变了，现在应该使用</p>
<p>DEFINE_SPINLOCK(x)</p>
<p>源代码中的定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">43</span>  #define <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>	<span class="token class-name">spinlock_t</span> x <span class="token operator">=</span> <span class="token function">__SPIN_LOCK_UNLOCKED</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>源代码对应的定义应该改为</p>
<p><code>static DEFINE_SPINLOCK(scull_u_lock);</code></p>
<p>内核中对 uid_t 使用了 kuid_t 进行定义，包裹上了一个结构体，进行比较的时候不能直接使用 <code>!=</code> 或者 <code>=</code> 应该使用 <code>uid_eq(uid0, uid1)</code></p>
<p>源码中的定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token keyword">static</span> <span class="token keyword">inline</span> bool <span class="token function">uid_eq</span><span class="token punctuation">(</span><span class="token class-name">kuid_t</span> left<span class="token punctuation">,</span> <span class="token class-name">kuid_t</span> right<span class="token punctuation">)</span>
<span class="token number">54</span>  <span class="token punctuation">&#123;</span>
<span class="token number">55</span>  	<span class="token keyword">return</span> <span class="token function">__kuid_val</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">__kuid_val</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">56</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="第六章代码"><a href="#第六章代码" class="headerlink" title="第六章代码"></a>第六章代码</h3><h4 id="scull-h"><a href="#scull-h" class="headerlink" title="scull.h"></a>scull.h</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * scull.h -- definitions for the char module
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 *
 * $Id: scull.h,v 1.15 2004/11/04 17:51:18 rubini Exp $
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_SCULL_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_SCULL_H_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioctl.h></span> <span class="token comment">/* needed for the _IOW etc stuff used later */</span></span>

<span class="token comment">/*
 * Macros to help debugging
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">PDEBUG             </span><span class="token comment">/* undef it, just in case */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">ifdef</span> <span class="token expression">__KERNEL__</span></span>
     <span class="token comment">/* This one if debugging is on, and kernel space */</span>
<span class="token macro property"><span class="token directive-hash">#</span>    <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">printk</span><span class="token punctuation">(</span> KERN_DEBUG </span><span class="token string">"scull: "</span> <span class="token expression">fmt<span class="token punctuation">,</span> </span><span class="token punctuation">##</span> <span class="token expression">args<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">else</span></span>
     <span class="token comment">/* This one for user space */</span>
<span class="token macro property"><span class="token directive-hash">#</span>    <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> </span><span class="token punctuation">##</span> <span class="token expression">args<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token comment">/* not debugging: nothing */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">PDEBUGG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PDEBUGG</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token comment">/* nothing: it's a placeholder */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_MAJOR</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_MAJOR</span> <span class="token expression"><span class="token number">0</span>   </span><span class="token comment">/* dynamic major by default */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_NR_DEVS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_NR_DEVS</span> <span class="token expression"><span class="token number">4</span>    </span><span class="token comment">/* scull0 through scull3 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_P_NR_DEVS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_P_NR_DEVS</span> <span class="token expression"><span class="token number">4</span>  </span><span class="token comment">/* scullpipe0 through scullpipe3 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * The bare device is a variable-length region of memory.
 * Use a linked list of indirect blocks.
 *
 * "scull_dev->data" points to an array of pointers, each
 * pointer refers to a memory area of SCULL_QUANTUM bytes.
 *
 * The array (quantum-set) is SCULL_QSET long.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_QUANTUM</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_QUANTUM</span> <span class="token expression"><span class="token number">4000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_QSET</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_QSET</span>    <span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * The pipe device is a simple circular buffer. Here its default size
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SCULL_P_BUFFER</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_P_BUFFER</span> <span class="token expression"><span class="token number">4000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * Representation of scull quantum sets.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>  <span class="token comment">/* Pointer to first quantum set */</span>
	<span class="token keyword">int</span> quantum<span class="token punctuation">;</span>              <span class="token comment">/* the current quantum size */</span>
	<span class="token keyword">int</span> qset<span class="token punctuation">;</span>                 <span class="token comment">/* the current array size */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>       <span class="token comment">/* amount of data stored here */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> access_key<span class="token punctuation">;</span>  <span class="token comment">/* used by sculluid and scullpriv */</span>
	<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>     <span class="token comment">/* mutual exclusion semaphore     */</span>
	<span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>	  <span class="token comment">/* Char device structure		*/</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Split minors in two parts
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TYPE</span><span class="token expression"><span class="token punctuation">(</span>minor<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>minor<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span>	</span><span class="token comment">/* high nibble */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NUM</span><span class="token expression"><span class="token punctuation">(</span>minor<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span>minor<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span>		</span><span class="token comment">/* low  nibble */</span></span>


<span class="token comment">/*
 * The different configurable parameters
 */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_major<span class="token punctuation">;</span>     <span class="token comment">/* main.c */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_nr_devs<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_quantum<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_qset<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token keyword">int</span> scull_p_buffer<span class="token punctuation">;</span>	<span class="token comment">/* pipe.c */</span>


<span class="token comment">/*
 * Prototypes for shared functions
 */</span>

<span class="token keyword">int</span>     <span class="token function">scull_p_init</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>    <span class="token function">scull_p_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">scull_access_init</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>    <span class="token function">scull_access_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span>     <span class="token function">scull_trim</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ssize_t</span> <span class="token function">scull_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
                   <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">scull_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
                    <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">loff_t</span>  <span class="token function">scull_llseek</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span>    <span class="token function">scull_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>
                    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">/*
 * Ioctl definitions
 */</span>

<span class="token comment">/* Use 'k' as magic number */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOC_MAGIC</span>  <span class="token char">'k'</span></span>
<span class="token comment">/* Please use a different 8-bit number in your code */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCRESET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*
 * S means "Set" through a ptr,
 * T means "Tell" directly with the argument value
 * G means "Get": reply by setting through a pointer
 * Q means "Query": response is on the return value
 * X means "eXchange": switch G and S atomically
 * H means "sHift": switch T and Q atomically
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCSQUANTUM</span> <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCSQSET</span>    <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCTQUANTUM</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCTQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCGQUANTUM</span> <span class="token expression"><span class="token function">_IOR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCGQSET</span>    <span class="token expression"><span class="token function">_IOR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCQQUANTUM</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">7</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCQQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCXQUANTUM</span> <span class="token expression"><span class="token function">_IOWR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCXQSET</span>    <span class="token expression"><span class="token function">_IOWR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCHQUANTUM</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">11</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCHQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">12</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*
 * The other entities only have "Tell" and "Query", because they're
 * not printed in the book, and there's no need to have all six.
 * (The previous stuff was only there to show different ways to do it.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_P_IOCTSIZE</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">13</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_P_IOCQSIZE</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">14</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* ... more to come */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOC_MAXNR</span> <span class="token expression"><span class="token number">14</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* _SCULL_H_ */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * main.c -- the bare scull char module
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 *
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/moduleparam.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span>  <span class="token comment">/* error codes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span>  <span class="token comment">/* O_ACCMODE */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>     <span class="token comment">/* everything... */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span> <span class="token comment">/* printk() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/seq_file.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span>  <span class="token comment">/* kmalloc() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span> <span class="token comment">/* size_t */</span></span>

<span class="token comment">// #include &lt;asm/system.h>		/* cli(), *_flags */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span> <span class="token comment">/* copy_*_user */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scull.h"</span> <span class="token comment">/* local definitions */</span></span>

<span class="token comment">/*
 * Our parameters which can be set at load time.
 */</span>

<span class="token keyword">int</span> scull_major <span class="token operator">=</span> SCULL_MAJOR<span class="token punctuation">;</span>
<span class="token keyword">int</span> scull_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> scull_nr_devs <span class="token operator">=</span> SCULL_NR_DEVS<span class="token punctuation">;</span> <span class="token comment">/* number of bare scull devices */</span>
<span class="token keyword">int</span> scull_quantum <span class="token operator">=</span> SCULL_QUANTUM<span class="token punctuation">;</span>
<span class="token keyword">int</span> scull_qset <span class="token operator">=</span> SCULL_QSET<span class="token punctuation">;</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_minor<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_nr_devs<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_quantum<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_qset<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> S_IRUGO<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"Alessandro Rubini, Jonathan Corbet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"Dual BSD/GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>scull_devices<span class="token punctuation">;</span> <span class="token comment">/* allocated in scull_init_module */</span>

<span class="token comment">/*
 * Empty out the scull device; must be called with the device
 * semaphore held.
 */</span>
<span class="token keyword">int</span> <span class="token function">scull_trim</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>
  <span class="token keyword">int</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span> <span class="token comment">/* "dev" is not-null */</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>dptr <span class="token operator">=</span> dev<span class="token operator">-></span>data<span class="token punctuation">;</span> dptr<span class="token punctuation">;</span> dptr <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* all the list items */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> qset<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dptr<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    next <span class="token operator">=</span> dptr<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>dptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  dev<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  dev<span class="token operator">-></span>quantum <span class="token operator">=</span> scull_quantum<span class="token punctuation">;</span>
  dev<span class="token operator">-></span>qset <span class="token operator">=</span> scull_qset<span class="token punctuation">;</span>
  dev<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG </span><span class="token comment">/* use proc only if debugging */</span></span>
<span class="token comment">/*
 * The proc filesystem: function to read and entry
 */</span>

<span class="token keyword">int</span> <span class="token function">scull_read_procmem</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                       <span class="token keyword">int</span> <span class="token operator">*</span>eof<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> limit <span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">80</span><span class="token punctuation">;</span> <span class="token comment">/* Don't print more than this */</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_nr_devs <span class="token operator">&amp;&amp;</span> len <span class="token operator">&lt;=</span> limit<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>qs <span class="token operator">=</span> d<span class="token operator">-></span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
    len <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token string">"\nDevice %i: qset %i, q %i, sz %li\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                   d<span class="token operator">-></span>qset<span class="token punctuation">,</span> d<span class="token operator">-></span>quantum<span class="token punctuation">,</span> d<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> qs <span class="token operator">&amp;&amp;</span> len <span class="token operator">&lt;=</span> limit<span class="token punctuation">;</span> qs <span class="token operator">=</span> qs<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* scan the list */</span>
      len <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token string">"  item at %p, qset at %p\n"</span><span class="token punctuation">,</span> qs<span class="token punctuation">,</span> qs<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token operator">-></span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>qs<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token comment">/* dump only the last item */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> d<span class="token operator">-></span>qset<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token operator">-></span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
            len <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token string">"    % 4i: %8p\n"</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> qs<span class="token operator">-></span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span>eof <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * For now, the seq_file implementation will exist in parallel.  The
 * older read_procmem function should maybe go away, though.
 */</span>

<span class="token comment">/*
 * Here are our sequence iteration methods.  Our "position" is
 * simply the device number.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">scull_seq_start</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pos <span class="token operator">>=</span> scull_nr_devs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* No more to read */</span>
  <span class="token keyword">return</span> scull_devices <span class="token operator">+</span> <span class="token operator">*</span>pos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">scull_seq_next</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">(</span><span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pos <span class="token operator">>=</span> scull_nr_devs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> scull_devices <span class="token operator">+</span> <span class="token operator">*</span>pos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_seq_stop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/* Actually, there's nothing to do here */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_seq_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span><span class="token punctuation">)</span>v<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>d<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
  <span class="token function">seq_printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"\nDevice %i: qset %i, q %i, sz %li\n"</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev <span class="token operator">-</span> scull_devices<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token operator">-></span>qset<span class="token punctuation">,</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">,</span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>d <span class="token operator">=</span> dev<span class="token operator">-></span>data<span class="token punctuation">;</span> d<span class="token punctuation">;</span> d <span class="token operator">=</span> d<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* scan the list */</span>
    <span class="token function">seq_printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"  item at %p, qset at %p\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> d<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>d<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token comment">/* dump only the last item */</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token function">seq_printf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"    % 4i: %8p\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> d<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Tie the sequence operators up.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">seq_operations</span> scull_seq_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>start <span class="token operator">=</span> scull_seq_start<span class="token punctuation">,</span>
                                              <span class="token punctuation">.</span>next <span class="token operator">=</span> scull_seq_next<span class="token punctuation">,</span>
                                              <span class="token punctuation">.</span>stop <span class="token operator">=</span> scull_seq_stop<span class="token punctuation">,</span>
                                              <span class="token punctuation">.</span>show <span class="token operator">=</span> scull_seq_show<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Now to implement the /proc file we need only make an open
 * method which sets up the sequence operators.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_proc_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">seq_open</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_seq_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Create a set of file operations for our proc file.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_proc_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
                                                <span class="token punctuation">.</span>open <span class="token operator">=</span> scull_proc_open<span class="token punctuation">,</span>
                                                <span class="token punctuation">.</span>read <span class="token operator">=</span> seq_read<span class="token punctuation">,</span>
                                                <span class="token punctuation">.</span>llseek <span class="token operator">=</span> seq_lseek<span class="token punctuation">,</span>
                                                <span class="token punctuation">.</span>release <span class="token operator">=</span> seq_release<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Actually create (and remove) the /proc file(s).
 */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_create_proc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span>entry<span class="token punctuation">;</span>
  <span class="token function">create_proc_read_entry</span><span class="token punctuation">(</span><span class="token string">"scullmem"</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* default mode */</span><span class="token punctuation">,</span>
                         <span class="token constant">NULL</span> <span class="token comment">/* parent dir */</span><span class="token punctuation">,</span> scull_read_procmem<span class="token punctuation">,</span>
                         <span class="token constant">NULL</span> <span class="token comment">/* client data */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  entry <span class="token operator">=</span> <span class="token function">create_proc_entry</span><span class="token punctuation">(</span><span class="token string">"scullseq"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    entry<span class="token operator">-></span>proc_fops <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_proc_ops<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_remove_proc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/* no problem if it was not registered */</span>
  <span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"scullmem"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token comment">/* parent dir */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"scullseq"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* SCULL_DEBUG */</span></span>

<span class="token comment">/*
 * Open and close
 */</span>

<span class="token keyword">int</span> <span class="token function">scull_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

  dev <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_cdev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span><span class="token punctuation">,</span> cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span> <span class="token comment">/* for other methods */</span>

  <span class="token comment">/* now trim to 0 the length of the device if open was write-only */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
    <span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* ignore errors */</span>
    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">scull_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token comment">/*
 * Follow the list
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span><span class="token function">scull_follow</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>qs <span class="token operator">=</span> dev<span class="token operator">-></span>data<span class="token punctuation">;</span>

  <span class="token comment">/* Allocate first qset explicitly if need be */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>qs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    qs <span class="token operator">=</span> dev<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>qs <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Never mind */</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>qs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Then follow the list */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>qs<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      qs<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token operator">-></span>next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Never mind */</span>
      <span class="token function">memset</span><span class="token punctuation">(</span>qs<span class="token operator">-></span>next<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_qset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    qs <span class="token operator">=</span> qs<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> qs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Data management: read and write
 */</span>

<span class="token class-name">ssize_t</span> <span class="token function">scull_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
                   <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span> <span class="token comment">/* the first listitem */</span>
  <span class="token keyword">int</span> quantum <span class="token operator">=</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">,</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>
  <span class="token keyword">int</span> itemsize <span class="token operator">=</span> quantum <span class="token operator">*</span> qset<span class="token punctuation">;</span> <span class="token comment">/* how many bytes in the listitem */</span>
  <span class="token keyword">int</span> item<span class="token punctuation">,</span> s_pos<span class="token punctuation">,</span> q_pos<span class="token punctuation">,</span> rest<span class="token punctuation">;</span>
  <span class="token class-name">ssize_t</span> retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>f_pos <span class="token operator">>=</span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>f_pos <span class="token operator">+</span> count <span class="token operator">></span> dev<span class="token operator">-></span>size<span class="token punctuation">)</span>
    count <span class="token operator">=</span> dev<span class="token operator">-></span>size <span class="token operator">-</span> <span class="token operator">*</span>f_pos<span class="token punctuation">;</span>

  <span class="token comment">/* find listitem, qset index, and offset in the quantum */</span>
  item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">/</span> itemsize<span class="token punctuation">;</span>
  rest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">%</span> itemsize<span class="token punctuation">;</span>
  s_pos <span class="token operator">=</span> rest <span class="token operator">/</span> quantum<span class="token punctuation">;</span>
  q_pos <span class="token operator">=</span> rest <span class="token operator">%</span> quantum<span class="token punctuation">;</span>

  <span class="token comment">/* follow the list up to the right position (defined elsewhere) */</span>
  dptr <span class="token operator">=</span> <span class="token function">scull_follow</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dptr <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token operator">!</span>dptr<span class="token operator">-></span>data <span class="token operator">||</span> <span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span> <span class="token comment">/* don't fill holes */</span>

  <span class="token comment">/* read only up to the end of this quantum */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">)</span>
    count <span class="token operator">=</span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">+</span> q_pos<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    retval <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span>f_pos <span class="token operator">+=</span> count<span class="token punctuation">;</span>
  retval <span class="token operator">=</span> count<span class="token punctuation">;</span>

out<span class="token operator">:</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">ssize_t</span> <span class="token function">scull_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
                    <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_qset</span> <span class="token operator">*</span>dptr<span class="token punctuation">;</span>
  <span class="token keyword">int</span> quantum <span class="token operator">=</span> dev<span class="token operator">-></span>quantum<span class="token punctuation">,</span> qset <span class="token operator">=</span> dev<span class="token operator">-></span>qset<span class="token punctuation">;</span>
  <span class="token keyword">int</span> itemsize <span class="token operator">=</span> quantum <span class="token operator">*</span> qset<span class="token punctuation">;</span>
  <span class="token keyword">int</span> item<span class="token punctuation">,</span> s_pos<span class="token punctuation">,</span> q_pos<span class="token punctuation">,</span> rest<span class="token punctuation">;</span>
  <span class="token class-name">ssize_t</span> retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span> <span class="token comment">/* value used in "goto out" statements */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>

  <span class="token comment">/* find listitem, qset index and offset in the quantum */</span>
  item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">/</span> itemsize<span class="token punctuation">;</span>
  rest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span>f_pos <span class="token operator">%</span> itemsize<span class="token punctuation">;</span>
  s_pos <span class="token operator">=</span> rest <span class="token operator">/</span> quantum<span class="token punctuation">;</span>
  q_pos <span class="token operator">=</span> rest <span class="token operator">%</span> quantum<span class="token punctuation">;</span>

  <span class="token comment">/* follow the list up to the right position */</span>
  dptr <span class="token operator">=</span> <span class="token function">scull_follow</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dptr<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>qset <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">)</span>
      <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> qset <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>quantum<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/* write only up to the end of this quantum */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">)</span>
    count <span class="token operator">=</span> quantum <span class="token operator">-</span> q_pos<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>dptr<span class="token operator">-></span>data<span class="token punctuation">[</span>s_pos<span class="token punctuation">]</span> <span class="token operator">+</span> q_pos<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    retval <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span>f_pos <span class="token operator">+=</span> count<span class="token punctuation">;</span>
  retval <span class="token operator">=</span> count<span class="token punctuation">;</span>

  <span class="token comment">/* update the size */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>size <span class="token operator">&lt;</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span>
    dev<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token operator">*</span>f_pos<span class="token punctuation">;</span>

out<span class="token operator">:</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The ioctl() implementation
 */</span>

<span class="token keyword">long</span> <span class="token function">scull_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tmp<span class="token punctuation">;</span>
  <span class="token keyword">int</span> retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * extract the type and number bitfields, and don't decode
   * wrong cmds: return ENOTTY (inappropriate ioctl) before access_ok()
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_TYPE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">!=</span> SCULL_IOC_MAGIC<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_NR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">></span> SCULL_IOC_MAXNR<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>

  <span class="token comment">/*
   * the direction is a bitmask, and VERIFY_WRITE catches R/W
   * transfers. `Type' is user-oriented, while
   * access_ok is kernel-oriented, so the concept of "read" and
   * "write" is reversed
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_DIR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">&amp;</span> _IOC_READ<span class="token punctuation">)</span>
    err <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">access_ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_DIR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">&amp;</span> _IOC_WRITE<span class="token punctuation">)</span>
    err <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">access_ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">case</span> SCULL_IOCRESET<span class="token operator">:</span>
    scull_quantum <span class="token operator">=</span> SCULL_QUANTUM<span class="token punctuation">;</span>
    scull_qset <span class="token operator">=</span> SCULL_QSET<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCSQUANTUM<span class="token operator">:</span> <span class="token comment">/* Set: arg points to the value */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    retval <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scull_quantum<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCTQUANTUM<span class="token operator">:</span> <span class="token comment">/* Tell: arg is the value */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    scull_quantum <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCGQUANTUM<span class="token operator">:</span> <span class="token comment">/* Get: arg is pointer to result */</span>
    retval <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>scull_quantum<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCQQUANTUM<span class="token operator">:</span> <span class="token comment">/* Query: return it (it's positive) */</span>
    <span class="token keyword">return</span> scull_quantum<span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCXQUANTUM<span class="token operator">:</span> <span class="token comment">/* eXchange: use arg as pointer */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> scull_quantum<span class="token punctuation">;</span>
    retval <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scull_quantum<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      retval <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCHQUANTUM<span class="token operator">:</span> <span class="token comment">/* sHift: like Tell + Query */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> scull_quantum<span class="token punctuation">;</span>
    scull_quantum <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCSQSET<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    retval <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scull_qset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCTQSET<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    scull_qset <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCGQSET<span class="token operator">:</span>
    retval <span class="token operator">=</span> <span class="token function">__put_user</span><span class="token punctuation">(</span>scull_qset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCQQSET<span class="token operator">:</span>
    <span class="token keyword">return</span> scull_qset<span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCXQSET<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> scull_qset<span class="token punctuation">;</span>
    retval <span class="token operator">=</span> <span class="token function">__get_user</span><span class="token punctuation">(</span>scull_qset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      retval <span class="token operator">=</span> <span class="token function">put_user</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_IOCHQSET<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> scull_qset<span class="token punctuation">;</span>
    scull_qset <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>

    <span class="token comment">/*
     * The following two change the buffer size for scullpipe.
     * The scullpipe device uses this same ioctl method, just to
     * write less code. Actually, it's the same driver, isn't it?
     */</span>

  <span class="token keyword">case</span> SCULL_P_IOCTSIZE<span class="token operator">:</span>
    scull_p_buffer <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SCULL_P_IOCQSIZE<span class="token operator">:</span>
    <span class="token keyword">return</span> scull_p_buffer<span class="token punctuation">;</span>

  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">/* redundant, as cmd was checked against MAXNR */</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The "extended" operations -- only seek
 */</span>

<span class="token class-name">loff_t</span> <span class="token function">scull_llseek</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token class-name">loff_t</span> newpos<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>whence<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">/* SEEK_SET */</span>
    newpos <span class="token operator">=</span> off<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">/* SEEK_CUR */</span>
    newpos <span class="token operator">=</span> filp<span class="token operator">-></span>f_pos <span class="token operator">+</span> off<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token comment">/* SEEK_END */</span>
    newpos <span class="token operator">=</span> dev<span class="token operator">-></span>size <span class="token operator">+</span> off<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">/* can't happen */</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newpos <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  filp<span class="token operator">-></span>f_pos <span class="token operator">=</span> newpos<span class="token punctuation">;</span>
  <span class="token keyword">return</span> newpos<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span> scull_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> scull_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> scull_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> scull_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> scull_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> scull_release<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Finally, the module stuff
 */</span>

<span class="token comment">/*
 * The cleanup function is used to handle initialization failures as well.
 * Thefore, it must be careful to work correctly even if some of the items
 * have not been initialized
 */</span>
<span class="token keyword">void</span> <span class="token function">scull_cleanup_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token class-name">dev_t</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> scull_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Get rid of our char dev entries */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scull_devices<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_nr_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">scull_trim</span><span class="token punctuation">(</span>scull_devices <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>scull_devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG </span><span class="token comment">/* use proc only if debugging */</span></span>
  <span class="token function">scull_remove_proc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">/* cleanup_module is never called if registering failed */</span>
  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> scull_nr_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* and call the cleanup functions for friend devices */</span>
  <span class="token function">scull_p_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">scull_access_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Set up the char_dev structure for this device.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_setup_cdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> err<span class="token punctuation">,</span> devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> scull_minor <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
  dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_fops<span class="token punctuation">;</span>
  err <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Fail gracefully if need be */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"Error %d adding scull%d"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">scull_init_module</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> result<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  <span class="token class-name">dev_t</span> dev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * Get a range of minor numbers to work with, asking for a dynamic
   * major unless directed otherwise at load time.
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scull_major<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dev <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> scull_minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> scull_nr_devs<span class="token punctuation">,</span> <span class="token string">"scull"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    result <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token punctuation">,</span> scull_minor<span class="token punctuation">,</span> scull_nr_devs<span class="token punctuation">,</span> <span class="token string">"scull"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    scull_major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"scull: can't get major %d\n"</span><span class="token punctuation">,</span> scull_major<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/*
   * allocate the devices -- we can't have them static, as the number
   * can be specified at load time
   */</span>
  scull_devices <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>scull_nr_devs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scull_devices<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    result <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> fail<span class="token punctuation">;</span> <span class="token comment">/* Make this more graceful */</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>scull_devices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scull_nr_devs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_dev</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Initialize each device. */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_nr_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>quantum <span class="token operator">=</span> scull_quantum<span class="token punctuation">;</span>
    scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>qset <span class="token operator">=</span> scull_qset<span class="token punctuation">;</span>
    <span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scull_setup_cdev</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* At this point call the init function for any friend device */</span>
  dev <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>scull_major<span class="token punctuation">,</span> scull_minor <span class="token operator">+</span> scull_nr_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dev <span class="token operator">+=</span> <span class="token function">scull_p_init</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dev <span class="token operator">+=</span> <span class="token function">scull_access_init</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG </span><span class="token comment">/* only when debugging */</span></span>
  <span class="token function">scull_create_proc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* succeed */</span>

fail<span class="token operator">:</span>
  <span class="token function">scull_cleanup_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>scull_init_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>scull_cleanup_module<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="pipe-c"><a href="#pipe-c" class="headerlink" title="pipe.c"></a>pipe.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * pipe.c -- fifo driver for scull
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 *
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/moduleparam.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span> <span class="token comment">/* error codes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>     <span class="token comment">/* everything... */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span> <span class="token comment">/* printk(), min() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/poll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span>  <span class="token comment">/* kmalloc() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span> <span class="token comment">/* size_t */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scull.h"</span> <span class="token comment">/* local definitions */</span></span>

<span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">wait_queue_head_t</span> inq<span class="token punctuation">,</span> outq<span class="token punctuation">;</span>       <span class="token comment">/* read and write queues */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token operator">*</span>end<span class="token punctuation">;</span>                <span class="token comment">/* begin of buf, end of buf */</span>
  <span class="token keyword">int</span> buffersize<span class="token punctuation">;</span>                    <span class="token comment">/* used in pointer arithmetic */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>rp<span class="token punctuation">,</span> <span class="token operator">*</span>wp<span class="token punctuation">;</span>                     <span class="token comment">/* where to read, where to write */</span>
  <span class="token keyword">int</span> nreaders<span class="token punctuation">,</span> nwriters<span class="token punctuation">;</span>            <span class="token comment">/* number of openings for r/w */</span>
  <span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span>async_queue<span class="token punctuation">;</span> <span class="token comment">/* asynchronous readers */</span>
  <span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>              <span class="token comment">/* mutual exclusion semaphore */</span>
  <span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>                  <span class="token comment">/* Char device structure */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/* parameters */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> scull_p_nr_devs <span class="token operator">=</span> SCULL_P_NR_DEVS<span class="token punctuation">;</span> <span class="token comment">/* number of pipe devices */</span>
<span class="token keyword">int</span> scull_p_buffer <span class="token operator">=</span> SCULL_P_BUFFER<span class="token punctuation">;</span>          <span class="token comment">/* buffer size */</span>
<span class="token class-name">dev_t</span> scull_p_devno<span class="token punctuation">;</span>                          <span class="token comment">/* Our first device number */</span>

<span class="token function">module_param</span><span class="token punctuation">(</span>scull_p_nr_devs<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* FIXME check perms */</span>
<span class="token function">module_param</span><span class="token punctuation">(</span>scull_p_buffer<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>scull_p_devices<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_p_fasync</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">spacefree</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
 * Open and close
 */</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_p_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>

  dev <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_cdev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span><span class="token punctuation">,</span> cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-></span>buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/* allocate the buffer */</span>
    dev<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>scull_p_buffer<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-></span>buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  dev<span class="token operator">-></span>buffersize <span class="token operator">=</span> scull_p_buffer<span class="token punctuation">;</span>
  dev<span class="token operator">-></span>end <span class="token operator">=</span> dev<span class="token operator">-></span>buffer <span class="token operator">+</span> dev<span class="token operator">-></span>buffersize<span class="token punctuation">;</span>
  dev<span class="token operator">-></span>rp <span class="token operator">=</span> dev<span class="token operator">-></span>wp <span class="token operator">=</span> dev<span class="token operator">-></span>buffer<span class="token punctuation">;</span> <span class="token comment">/* rd and wr from the beginning */</span>

  <span class="token comment">/* use f_mode,not  f_flags: it's cleaner (fs/open.c tells why) */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_mode <span class="token operator">&amp;</span> FMODE_READ<span class="token punctuation">)</span>
    dev<span class="token operator">-></span>nreaders<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_mode <span class="token operator">&amp;</span> FMODE_WRITE<span class="token punctuation">)</span>
    dev<span class="token operator">-></span>nwriters<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">nonseekable_open</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_p_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>

  <span class="token comment">/* remove this filp from the asynchronously notified filp's */</span>
  <span class="token function">scull_p_fasync</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> filp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_mode <span class="token operator">&amp;</span> FMODE_READ<span class="token punctuation">)</span>
    dev<span class="token operator">-></span>nreaders<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_mode <span class="token operator">&amp;</span> FMODE_WRITE<span class="token punctuation">)</span>
    dev<span class="token operator">-></span>nwriters<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>nreaders <span class="token operator">+</span> dev<span class="token operator">-></span>nwriters <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* the other fields are not checked on open */</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Data management: read and write
 */</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">scull_p_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span>
                            <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>rp <span class="token operator">==</span> dev<span class="token operator">-></span>wp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* nothing to read */</span>
    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">/* release the lock */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
    <span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" reading: going to sleep\n"</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>inq<span class="token punctuation">,</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>rp <span class="token operator">!=</span> dev<span class="token operator">-></span>wp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span> <span class="token comment">/* signal: tell the fs layer to handle it */</span>
    <span class="token comment">/* otherwise loop, but first reacquire the lock */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/* ok, data is there, return something */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>wp <span class="token operator">></span> dev<span class="token operator">-></span>rp<span class="token punctuation">)</span>
    count <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>wp <span class="token operator">-</span> dev<span class="token operator">-></span>rp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token comment">/* the write pointer has wrapped, return data up to dev->end */</span>
    count <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>end <span class="token operator">-</span> dev<span class="token operator">-></span>rp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> dev<span class="token operator">-></span>rp<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  dev<span class="token operator">-></span>rp <span class="token operator">+=</span> count<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>rp <span class="token operator">==</span> dev<span class="token operator">-></span>end<span class="token punctuation">)</span>
    dev<span class="token operator">-></span>rp <span class="token operator">=</span> dev<span class="token operator">-></span>buffer<span class="token punctuation">;</span> <span class="token comment">/* wrapped */</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* finally, awake any writers and return */</span>
  <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>outq<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" did read %li bytes\n"</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Wait for space for writing; caller must hold device semaphore.  On
 * error the semaphore will be released before returning. */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_getwritespace</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">spacefree</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* full */</span>
    <span class="token function">DEFINE_WAIT</span><span class="token punctuation">(</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
    <span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" writing: going to sleep\n"</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prepare_to_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>outq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">,</span> TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">spacefree</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">finish_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>outq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span> <span class="token comment">/* signal: tell the fs layer to handle it */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* How much space is free? */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">spacefree</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>rp <span class="token operator">==</span> dev<span class="token operator">-></span>wp<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dev<span class="token operator">-></span>buffersize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>rp <span class="token operator">+</span> dev<span class="token operator">-></span>buffersize <span class="token operator">-</span> dev<span class="token operator">-></span>wp<span class="token punctuation">)</span> <span class="token operator">%</span> dev<span class="token operator">-></span>buffersize<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">scull_p_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>
                             <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>f_pos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>

  <span class="token comment">/* Make sure there's space to write */</span>
  result <span class="token operator">=</span> <span class="token function">scull_getwritespace</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span> <span class="token comment">/* scull_getwritespace called up(&amp;dev->sem) */</span>

  <span class="token comment">/* ok, space is there, accept something */</span>
  count <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token function">spacefree</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>wp <span class="token operator">>=</span> dev<span class="token operator">-></span>rp<span class="token punctuation">)</span>
    count <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>end <span class="token operator">-</span> dev<span class="token operator">-></span>wp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* to end-of-buf */</span>
  <span class="token keyword">else</span> <span class="token comment">/* the write pointer has wrapped, fill up to rp-1 */</span>
    count <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>rp <span class="token operator">-</span> dev<span class="token operator">-></span>wp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"Going to accept %li bytes to %p from %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>count<span class="token punctuation">,</span> dev<span class="token operator">-></span>wp<span class="token punctuation">,</span>
         buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>wp<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  dev<span class="token operator">-></span>wp <span class="token operator">+=</span> count<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>wp <span class="token operator">==</span> dev<span class="token operator">-></span>end<span class="token punctuation">)</span>
    dev<span class="token operator">-></span>wp <span class="token operator">=</span> dev<span class="token operator">-></span>buffer<span class="token punctuation">;</span> <span class="token comment">/* wrapped */</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* finally, awake any reader */</span>
  <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>inq<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* blocked in read() and select() */</span>

  <span class="token comment">/* and signal asynchronous readers, explained late in chapter 5 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>async_queue<span class="token punctuation">)</span>
    <span class="token function">kill_fasync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>async_queue<span class="token punctuation">,</span> SIGIO<span class="token punctuation">,</span> POLL_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" did write %li bytes\n"</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">scull_p_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * The buffer is circular; it is considered full
   * if "wp" is right behind "rp" and empty if the
   * two are equal.
   */</span>
  <span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>inq<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>outq<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>rp <span class="token operator">!=</span> dev<span class="token operator">-></span>wp<span class="token punctuation">)</span>
    mask <span class="token operator">|=</span> POLLIN <span class="token operator">|</span> POLLRDNORM<span class="token punctuation">;</span> <span class="token comment">/* readable */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">spacefree</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
    mask <span class="token operator">|=</span> POLLOUT <span class="token operator">|</span> POLLWRNORM<span class="token punctuation">;</span> <span class="token comment">/* writable */</span>
  <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_p_fasync</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">fasync_helper</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> filp<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>async_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* FIXME this should use seq_file */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG</span></span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scullp_proc_offset</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token class-name">off_t</span> <span class="token operator">*</span>offset<span class="token punctuation">,</span>
                               <span class="token keyword">int</span> <span class="token operator">*</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>offset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>offset <span class="token operator">>=</span> <span class="token operator">*</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Not there yet */</span>
    <span class="token operator">*</span>offset <span class="token operator">-=</span> <span class="token operator">*</span>len<span class="token punctuation">;</span>
    <span class="token operator">*</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* We're into the interesting stuff now */</span>
    <span class="token operator">*</span>start <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token operator">*</span>offset<span class="token punctuation">;</span>
    <span class="token operator">*</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_read_p_mem</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>
                            <span class="token keyword">int</span> <span class="token operator">*</span>eof<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> len<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LIMIT</span> <span class="token expression"><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">-</span> <span class="token number">200</span><span class="token punctuation">)</span> </span><span class="token comment">/* don't print any more after this size */</span></span>
  <span class="token operator">*</span>start <span class="token operator">=</span> buf<span class="token punctuation">;</span>
  len <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"Default buffersize is %i\n"</span><span class="token punctuation">,</span> scull_p_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_p_nr_devs <span class="token operator">&amp;&amp;</span> len <span class="token operator">&lt;=</span> LIMIT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    p <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_p_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
    len <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token string">"\nDevice %i: %p\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*		len += sprintf(buf+len, "   Queues: %p %p\n", p->inq,
     * p->outq);*/</span>
    len <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token string">"   Buffer: %p to %p (%i bytes)\n"</span><span class="token punctuation">,</span> p<span class="token operator">-></span>buffer<span class="token punctuation">,</span>
                   p<span class="token operator">-></span>end<span class="token punctuation">,</span> p<span class="token operator">-></span>buffersize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    len <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token string">"   rp %p   wp %p\n"</span><span class="token punctuation">,</span> p<span class="token operator">-></span>rp<span class="token punctuation">,</span> p<span class="token operator">-></span>wp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    len <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token string">"   readers %i   writers %i\n"</span><span class="token punctuation">,</span> p<span class="token operator">-></span>nreaders<span class="token punctuation">,</span>
                   p<span class="token operator">-></span>nwriters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scullp_proc_offset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> start<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span>eof <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> LIMIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * The file operations for the pipe device
 * (some are overlayed with bare scull)
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_pipe_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span> no_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> scull_p_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> scull_p_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>poll <span class="token operator">=</span> scull_p_poll<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> scull_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> scull_p_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> scull_p_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fasync <span class="token operator">=</span> scull_p_fasync<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Set up a cdev entry.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_p_setup_cdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> err<span class="token punctuation">,</span> devno <span class="token operator">=</span> scull_p_devno <span class="token operator">+</span> index<span class="token punctuation">;</span>

  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_pipe_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
  err <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Fail gracefully if need be */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"Error %d adding scullpipe%d"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * Initialize the pipe devs; return how many we did.
 */</span>
<span class="token keyword">int</span> <span class="token function">scull_p_init</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> firstdev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">,</span> result<span class="token punctuation">;</span>

  result <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>firstdev<span class="token punctuation">,</span> scull_p_nr_devs<span class="token punctuation">,</span> <span class="token string">"scullp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"Unable to get scullp region, error %d\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  scull_p_devno <span class="token operator">=</span> firstdev<span class="token punctuation">;</span>
  scull_p_devices <span class="token operator">=</span>
      <span class="token function">kmalloc</span><span class="token punctuation">(</span>scull_p_nr_devs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scull_p_devices <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>firstdev<span class="token punctuation">,</span> scull_p_nr_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>scull_p_devices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scull_p_nr_devs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_pipe</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_p_nr_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>scull_p_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>inq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>scull_p_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>outq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_p_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scull_p_setup_cdev</span><span class="token punctuation">(</span>scull_p_devices <span class="token operator">+</span> i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG</span></span>
  <span class="token function">create_proc_read_entry</span><span class="token punctuation">(</span><span class="token string">"scullpipe"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> scull_read_p_mem<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token keyword">return</span> scull_p_nr_devs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * This is called by cleanup_module or on failure.
 * It is required to never fail, even if nothing was initialized first
 */</span>
<span class="token keyword">void</span> <span class="token function">scull_p_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SCULL_DEBUG</span></span>
  <span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"scullpipe"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scull_p_devices<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">/* nothing else to release */</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scull_p_nr_devs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_p_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>scull_p_devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">kfree</span><span class="token punctuation">(</span>scull_p_devices<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>scull_p_devno<span class="token punctuation">,</span> scull_p_nr_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scull_p_devices <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* pedantic */</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="access-c"><a href="#access-c" class="headerlink" title="access.c"></a>access.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * access.c -- the files with access control on open
 *
 * Copyright (C) 2001 Alessandro Rubini and Jonathan Corbet
 * Copyright (C) 2001 O'Reilly &amp; Associates
 *
 * The source code in this file can be freely used, adapted,
 * and redistributed in source or binary form, so long as an
 * acknowledgment appears in derived source files.  The citation
 * should list that the code comes from the book "Linux Device
 * Drivers" by Alessandro Rubini and Jonathan Corbet, published
 * by O'Reilly &amp; Associates.   No warranty is attached;
 * we cannot take responsibility for errors or fitness for use.
 *
 * $Id: access.c,v 1.17 2004/09/26 07:29:56 gregkh Exp $
 */</span>

<span class="token comment">/* FIXME: cloned devices as a use for kobjects? */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/atomic.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span> <span class="token comment">/* error codes */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>     <span class="token comment">/* everything... */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span> <span class="token comment">/* printk() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/list.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span> <span class="token comment">/* kmalloc() */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/tty.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span> <span class="token comment">/* size_t */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"scull.h"</span> <span class="token comment">/* local definitions */</span></span>

<span class="token keyword">static</span> <span class="token class-name">dev_t</span> scull_a_firstdev<span class="token punctuation">;</span> <span class="token comment">/* Where our range begins */</span>

<span class="token comment">/*
 * These devices fall back on the main scull operations. They only
 * differ in the implementation of open() and close()
 */</span>

<span class="token comment">/************************************************************************
 *
 * The first device is the single-open one,
 *  it has an hw structure and an open count
 */</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> scull_s_device<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">atomic_t</span> scull_s_available <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_s_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_s_device<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">atomic_dec_and_test</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_s_available<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_s_available<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span> <span class="token comment">/* already open */</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* then, everything else is copied from the bare scull device */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span>
    <span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_s_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_s_available<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* release the device */</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The other operations for the single-open device come from the bare device
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_sngl_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span> scull_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> scull_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> scull_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> scull_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> scull_s_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> scull_s_release<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/************************************************************************
 *
 * Next, the "uid" device. It can be opened multiple times by the
 * same user, but access is denied to other users if the device is open
 */</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> scull_u_device<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> scull_u_count<span class="token punctuation">;</span>    <span class="token comment">/* initialized to 0 by default */</span>
<span class="token keyword">static</span> <span class="token class-name">kuid_t</span> scull_u_owner<span class="token punctuation">;</span> <span class="token comment">/* initialized to 0 by default */</span>
<span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_u_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_u_device<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

  <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scull_u_count <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token function">uid_eq</span><span class="token punctuation">(</span>scull_u_owner<span class="token punctuation">,</span> <span class="token function">current_cred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>uid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  <span class="token comment">/* allow user */</span>
      <span class="token operator">!</span><span class="token function">uid_eq</span><span class="token punctuation">(</span>scull_u_owner<span class="token punctuation">,</span> <span class="token function">current_cred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>euid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">/* allow whoever did su */</span>
      <span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_DAC_OVERRIDE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                   <span class="token comment">/* still allow root */</span>
    <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span> <span class="token comment">/* -EPERM would confuse the user */</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>scull_u_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    scull_u_owner <span class="token operator">=</span> <span class="token function">current_cred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>uid<span class="token punctuation">;</span> <span class="token comment">/* grab it */</span>

  scull_u_count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* then, everything else is copied from the bare scull device */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span>
    <span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_u_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scull_u_count<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">/* nothing else */</span>
  <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_u_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The other operations for the device come from the bare device
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_user_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span> scull_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> scull_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> scull_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> scull_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> scull_u_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> scull_u_release<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/************************************************************************
 *
 * Next, the device with blocking-open based on uid
 */</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> scull_w_device<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> scull_w_count<span class="token punctuation">;</span>    <span class="token comment">/* initialized to 0 by default */</span>
<span class="token keyword">static</span> <span class="token class-name">kuid_t</span> scull_w_owner<span class="token punctuation">;</span> <span class="token comment">/* initialized to 0 by default */</span>
<span class="token keyword">static</span> <span class="token function">DECLARE_WAIT_QUEUE_HEAD</span><span class="token punctuation">(</span>scull_w_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// static spinlock_t scull_w_lock = SPIN_LOCK_UNLOCKED;</span>
<span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>scull_w_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">scull_w_available</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> scull_w_count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">uid_eq</span><span class="token punctuation">(</span>scull_w_owner<span class="token punctuation">,</span> <span class="token function">current_cred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>uid<span class="token punctuation">)</span> <span class="token operator">||</span>
         <span class="token function">uid_eq</span><span class="token punctuation">(</span>scull_w_owner<span class="token punctuation">,</span> <span class="token function">current_cred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>euid<span class="token punctuation">)</span> <span class="token operator">||</span>
         <span class="token function">capable</span><span class="token punctuation">(</span>CAP_DAC_OVERRIDE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_w_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>scull_w_device<span class="token punctuation">;</span> <span class="token comment">/* device information */</span>

  <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_w_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">scull_w_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_w_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>scull_w_wait<span class="token punctuation">,</span> <span class="token function">scull_w_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span> <span class="token comment">/* tell the fs layer to handle it */</span>
    <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_w_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scull_w_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    scull_w_owner <span class="token operator">=</span> <span class="token function">current_cred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>uid<span class="token punctuation">;</span> <span class="token comment">/* grab it */</span>
  scull_w_count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_w_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* then, everything else is copied from the bare scull device */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span>
    <span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_w_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> temp<span class="token punctuation">;</span>

  <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_w_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scull_w_count<span class="token operator">--</span><span class="token punctuation">;</span>
  temp <span class="token operator">=</span> scull_w_count<span class="token punctuation">;</span>
  <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_w_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">wake_up_interruptible_sync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_w_wait<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* awake other uid's */</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The other operations for the device come from the bare device
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_wusr_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span> scull_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> scull_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> scull_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> scull_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> scull_w_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> scull_w_release<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/************************************************************************
 *
 * Finally the `cloned' private device. This is trickier because it
 * involves list management, and dynamic allocation.
 */</span>

<span class="token comment">/* The clone-specific data structure includes a key field */</span>

<span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> device<span class="token punctuation">;</span>
  <span class="token class-name">dev_t</span> key<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/* The list of devices, and a lock to protect it */</span>
<span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>scull_c_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// static spinlock_t scull_c_lock = SPIN_LOCK_UNLOCKED;</span>
<span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>scull_c_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* A placeholder scull_dev which really just holds the cdev stuff. */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> scull_c_device<span class="token punctuation">;</span>

<span class="token comment">/* Look for a device or create one if missing */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span><span class="token function">scull_c_lookfor_device</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span> <span class="token operator">*</span>lptr<span class="token punctuation">;</span>

  <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>lptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_c_list<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lptr<span class="token operator">-></span>key <span class="token operator">==</span> key<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* not found */</span>
  lptr <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lptr<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token comment">/* initialize the device */</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>lptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  lptr<span class="token operator">-></span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token function">scull_trim</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* initialize it */</span>
  <span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">.</span>sem<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* place it in the list */</span>
  <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lptr<span class="token operator">-></span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_c_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_c_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
  <span class="token class-name">dev_t</span> key<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-></span>signal<span class="token operator">-></span>tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">PDEBUG</span><span class="token punctuation">(</span><span class="token string">"Process \"%s\" has no ctl tty\n"</span><span class="token punctuation">,</span> current<span class="token operator">-></span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  key <span class="token operator">=</span> <span class="token function">tty_devnum</span><span class="token punctuation">(</span>current<span class="token operator">-></span>signal<span class="token operator">-></span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* look for a scullc device in the list */</span>
  <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_c_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dev <span class="token operator">=</span> <span class="token function">scull_c_lookfor_device</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scull_c_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

  <span class="token comment">/* then, everything else is copied from the bare scull device */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_ACCMODE<span class="token punctuation">)</span> <span class="token operator">==</span> O_WRONLY<span class="token punctuation">)</span>
    <span class="token function">scull_trim</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  filp<span class="token operator">-></span>private_data <span class="token operator">=</span> dev<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* success */</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scull_c_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/*
   * Nothing to do, because the device is persistent.
   * A `real' cloned device should be freed on last close
   */</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * The other operations for the device come from the bare device
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> scull_priv_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span> scull_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> scull_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> scull_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> scull_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> scull_c_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> scull_c_release<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/************************************************************************
 *
 * And the init and cleanup functions come last
 */</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">scull_adev_info</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>sculldev<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> scull_access_devs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token string">"scullsingle"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_s_device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_sngl_fops<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                         <span class="token punctuation">&#123;</span><span class="token string">"sculluid"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_u_device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_user_fops<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                         <span class="token punctuation">&#123;</span><span class="token string">"scullwuid"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_w_device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_wusr_fops<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                         <span class="token punctuation">&#123;</span><span class="token string">"sullpriv"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_c_device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_priv_fops<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_N_ADEVS</span> <span class="token expression"><span class="token number">4</span></span></span>

<span class="token comment">/*
 * Set up a single device.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scull_access_setup</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> devno<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">scull_adev_info</span> <span class="token operator">*</span>devinfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> devinfo<span class="token operator">-></span>sculldev<span class="token punctuation">;</span>
  <span class="token keyword">int</span> err<span class="token punctuation">;</span>

  <span class="token comment">/* Initialize the device structure */</span>
  dev<span class="token operator">-></span>quantum <span class="token operator">=</span> scull_quantum<span class="token punctuation">;</span>
  dev<span class="token operator">-></span>qset <span class="token operator">=</span> scull_qset<span class="token punctuation">;</span>
  <span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>sem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Do the cdev stuff. */</span>
  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devinfo<span class="token operator">-></span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">kobject_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>kobj<span class="token punctuation">,</span> devinfo<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
  err <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Fail gracefully if need be */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"Error %d adding %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> devinfo<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kobject_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>kobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE <span class="token string">"%s registered at %x\n"</span><span class="token punctuation">,</span> devinfo<span class="token operator">-></span>name<span class="token punctuation">,</span> devno<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">scull_access_init</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> firstdev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> result<span class="token punctuation">,</span> i<span class="token punctuation">;</span>

  <span class="token comment">/* Get our number space */</span>
  result <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>firstdev<span class="token punctuation">,</span> SCULL_N_ADEVS<span class="token punctuation">,</span> <span class="token string">"sculla"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"sculla: device number registration failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  scull_a_firstdev <span class="token operator">=</span> firstdev<span class="token punctuation">;</span>

  <span class="token comment">/* Set up each device. */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SCULL_N_ADEVS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">scull_access_setup</span><span class="token punctuation">(</span>firstdev <span class="token operator">+</span> i<span class="token punctuation">,</span> scull_access_devs <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> SCULL_N_ADEVS<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * This is called by cleanup_module or on failure.
 * It is required to never fail, even if nothing was initialized first
 */</span>
<span class="token keyword">void</span> <span class="token function">scull_access_cleanup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">scull_listitem</span> <span class="token operator">*</span>lptr<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token comment">/* Clean up the static devs */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SCULL_N_ADEVS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">scull_dev</span> <span class="token operator">*</span>dev <span class="token operator">=</span> scull_access_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sculldev<span class="token punctuation">;</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scull_trim</span><span class="token punctuation">(</span>scull_access_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sculldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* And all the cloned devices */</span>
  <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>lptr<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scull_c_list<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lptr<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scull_trim</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>lptr<span class="token operator">-></span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>lptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* Free up our number space */</span>
  <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>scull_a_firstdev<span class="token punctuation">,</span> SCULL_N_ADEVS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="第六章代码测试"><a href="#第六章代码测试" class="headerlink" title="第六章代码测试"></a>第六章代码测试</h3><h4 id="关于-ioctl"><a href="#关于-ioctl" class="headerlink" title="关于 ioctl"></a>关于 <code>ioctl</code></h4><p>我在 <code>scull_ioctl</code> 中插入一个 log</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">case</span> SCULL_IOCRESET<span class="token operator">:</span>
  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"scull ioctl cmd: SCULL_IOCRESET arg:%lu\n"</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scull_quantum <span class="token operator">=</span> SCULL_QUANTUM<span class="token punctuation">;</span>
  scull_qset <span class="token operator">=</span> SCULL_QSET<span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOC_MAGIC</span>  <span class="token char">'k'</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCRESET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCSQUANTUM</span> <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCSQSET</span>    <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCTQUANTUM</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCTQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCGQUANTUM</span> <span class="token expression"><span class="token function">_IOR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCGQSET</span>    <span class="token expression"><span class="token function">_IOR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCQQUANTUM</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">7</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCQQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCXQUANTUM</span> <span class="token expression"><span class="token function">_IOWR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCXQSET</span>    <span class="token expression"><span class="token function">_IOWR</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCHQUANTUM</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">11</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCULL_IOCHQSET</span>    <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span>SCULL_IOC_MAGIC<span class="token punctuation">,</span>  <span class="token number">12</span><span class="token punctuation">)</span></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> arg <span class="token operator">=</span> <span class="token number">114514</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/scull0"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fopen error number: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SCULL_IOCRESET<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ioctl error number: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译后执行，结果如下</p>
<pre class="line-numbers language-none"><code class="language-none">rt@rogerthat ~&#x2F;k&#x2F;s&#x2F;test&gt; sudo dmesg -C
rt@rogerthat ~&#x2F;k&#x2F;s&#x2F;test&gt; .&#x2F;a.out
rt@rogerthat ~&#x2F;k&#x2F;s&#x2F;test&gt; sudo dmesg 
[ 5814.272212] scull ioctl cmd: SCULL_IOCRESET arg:114514<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="关于阻塞读写"><a href="#关于阻塞读写" class="headerlink" title="关于阻塞读写"></a>关于阻塞读写</h4><p>踩了坑，他分配的设备 MINOR 和 scull.init 对不上，导致找不到对应设备</p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240426030320220.png" alt="image-20240426030320220"></p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240426030413865.png" alt="image-20240426030413865"></p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240426030420835.png" alt="image-20240426030420835"></p>
<h4 id="关于非阻塞读写"><a href="#关于非阻塞读写" class="headerlink" title="关于非阻塞读写"></a>关于非阻塞读写</h4><p>有点问题，为啥这个 read 读不出东西，回头再看看了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/scullpipe0"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_RDONLY <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fopen error number: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// nonblock read</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Read: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// nonblock write</span>
    <span class="token comment">// write long string</span>
    <span class="token keyword">char</span> long_string<span class="token punctuation">[</span><span class="token number">4002</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// larger than pip buffer</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>long_string<span class="token punctuation">,</span> <span class="token char">'a'</span><span class="token punctuation">,</span> <span class="token number">4001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    long_string<span class="token punctuation">[</span><span class="token number">4001</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> long_string<span class="token punctuation">,</span> <span class="token number">4001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Write a long string\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// fcntl(fd, F_SETFL, fcntl(fd, F_GETFL) | O_NONBLOCK);</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240426033534189.png" alt="image-20240426033534189"></p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240426035640132.png" alt="image-20240426035640132"></p>
<p><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/image-20240426035650075.png" alt="image-20240426035650075"></p>
<h4 id="关于-access"><a href="#关于-access" class="headerlink" title="关于 access"></a>关于 access</h4><h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p>[1] <a target="_blank" rel="noopener" href="https://ty-chen.github.io/linux-kernel-char-device/">https://ty-chen.github.io/linux-kernel-char-device/</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wr-web.github.io">RT</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wr-web.github.io/2024/04/23/LDD3-week1/">https://wr-web.github.io/2024/04/23/LDD3-week1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wr-web.github.io" target="_blank">R0gerThat</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive50.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LDD3 学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/17/LLD3-week0/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive52.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LDD3 学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive50.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-01</div><div class="title">LDD3 学习笔记</div></div></a></div><div><a href="/2024/04/17/LLD3-week0/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive52.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-17</div><div class="title">LDD3 学习笔记</div></div></a></div><div><a href="/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/" title="LDD3 学习笔记"><img class="cover" src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-07</div><div class="title">LDD3 学习笔记</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">RT</div><div class="author-info__description">@Vidar-Team @CTFer @Game Lover </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/wr-web"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wr-web" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:orz1053131305@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://wr-web.github.io/atom.xml" target="_blank" title="Rss"><i class="fas fa-rss" style="color: #2d69d7;"></i></a><a class="social-icon" href="https://space.bilibili.com/13582048" target="_blank" title="BiliBili"><i class="fab fa-bilibili" style="color: #00a1d6;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">家人们加个友链</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LDD3-WEEK1"><span class="toc-number">1.</span> <span class="toc-text">LDD3 WEEK1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%E7%BB%AD"><span class="toc-number">1.1.</span> <span class="toc-text">第三章续</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%8C%E5%85%B3%E4%BA%8E%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">第四章，关于调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%8C%E5%B9%B6%E5%8F%91%EF%BC%8C%E7%AB%9E%E4%BA%89"><span class="toc-number">1.3.</span> <span class="toc-text">第五章，并发，竞争</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#scull-c"><span class="toc-number">1.3.1.</span> <span class="toc-text">scull.c</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E9%AB%98%E7%BA%A7%E5%AD%97%E7%AC%A6%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.4.</span> <span class="toc-text">第六章 高级字符驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ioctl-x2F-pipe-defination"><span class="toc-number">1.4.1.</span> <span class="toc-text">ioctl&#x2F;pipe defination</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BB%A3%E7%A0%81"><span class="toc-number">1.4.2.</span> <span class="toc-text">第六章代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#scull-h"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">scull.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#main-c"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">main.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pipe-c"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">pipe.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#access-c"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">access.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.3.</span> <span class="toc-text">第六章代码测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-ioctl"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">关于 ioctl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E9%98%BB%E5%A1%9E%E8%AF%BB%E5%86%99"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">关于阻塞读写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E9%9D%9E%E9%98%BB%E5%A1%9E%E8%AF%BB%E5%86%99"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">关于非阻塞读写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-access"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">关于 access</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">引用</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive51.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/05/07/%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%85/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-05-07T04:00:00.000Z" title="发表于 2024-05-07 12:00:00">2024-05-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive50.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/05/01/LDD3-week2/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-05-01T04:00:00.000Z" title="发表于 2024-05-01 12:00:00">2024-05-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/23/LDD3-week1/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/04/23/LDD3-week1/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-04-23T04:00:00.000Z" title="发表于 2024-04-23 12:00:00">2024-04-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/17/LLD3-week0/" title="LDD3 学习笔记"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive52.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LDD3 学习笔记"/></a><div class="content"><a class="title" href="/2024/04/17/LLD3-week0/" title="LDD3 学习笔记">LDD3 学习笔记</a><time datetime="2024-04-17T04:00:00.000Z" title="发表于 2024-04-17 12:00:00">2024-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/12/windows-terminal-customization/" title="Windows Terminal Customization"><img src="https://cdn.jsdelivr.net/gh/wr-web/picture/archive40.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows Terminal Customization"/></a><div class="content"><a class="title" href="/2024/01/12/windows-terminal-customization/" title="Windows Terminal Customization">Windows Terminal Customization</a><time datetime="2024-01-12T04:00:00.000Z" title="发表于 2024-01-12 12:00:00">2024-01-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/wr-web/picture/archive49.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By RT</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '017d73efa3d7d9bd35c1',
      clientSecret: '0b3746330e76c8310d622e4ae2d18a227afdfdd1',
      repo: 'blog_talk',
      owner: 'wr-web',
      admin: ['wr-web'],
      id: '01bf8c81510e6762cc4bb0bc3a0118b9',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>